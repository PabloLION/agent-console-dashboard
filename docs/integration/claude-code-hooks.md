# Claude Code Plugin Integration

## Overview

Agent Console Dashboard integrates with Claude Code as a **plugin**. The plugin
declares hooks in `.claude-plugin/plugin.json` (generated by `build.rs`), and
Claude Code manages the lifecycle. No manual `settings.json` editing required.

Three hooks are registered:

| Event               | Status set  | Why                                          |
| ------------------- | ----------- | -------------------------------------------- |
| `Stop`              | `attention` | Session stopped, may need user attention      |
| `SessionStart`      | `attention` | Session exists but Claude isn't processing yet |
| `UserPromptSubmit`  | `working`   | User sent a prompt, Claude is now working     |

## Prerequisites

- Agent Console Dashboard installed (`acd` binary in PATH)
- Claude Code with plugin support

## Quick Start

```sh
# Install the ACD plugin from the repository marketplace
claude plugin marketplace add PabloLION/agent-console-dashboard
claude plugin install agent-console-dashboard

# Or use the service installer (installs both system service and plugin)
acd service install
```

## How It Works

### Plugin Manifest

The build system generates `.claude-plugin/plugin.json` at the workspace root.
This file declares the hooks that Claude Code should register:

```json
{
  "name": "agent-console-dashboard",
  "version": "0.1.0",
  "hooks": {
    "Stop": [{ "matcher": "", "hooks": [{ "type": "command", "command": "acd claude-hook attention", "timeout": 10 }] }],
    "SessionStart": [{ "matcher": "", "hooks": [{ "type": "command", "command": "acd claude-hook attention", "timeout": 10 }] }],
    "UserPromptSubmit": [{ "matcher": "", "hooks": [{ "type": "command", "command": "acd claude-hook working", "timeout": 10 }] }]
  }
}
```

### `acd claude-hook` Subcommand

When Claude Code fires a hook, it invokes `acd claude-hook <status>`. The
subcommand:

1. Reads JSON from stdin (Claude Code hook payload)
2. Extracts `session_id` from the JSON
3. Sends a SET command to the daemon via Unix socket
4. Outputs `{"continue": true}` on stdout (Claude Code protocol)

Exit codes per the Claude Code hook spec:

| Code | Meaning        | When                                   |
| ---- | -------------- | -------------------------------------- |
| 0    | Success        | Status forwarded, or daemon not running |
| 2    | Blocking error | Malformed JSON on stdin                 |

When the daemon is not running, the subcommand exits 0 with a `systemMessage`
field so Claude Code isn't blocked but the condition is visible.

### Hook JSON Stdin Format

Claude Code passes JSON via stdin to hook commands. All hooks receive these
common fields (per the [hooks reference]):

| Field             | Type   | Required | Description                             |
| ----------------- | ------ | -------- | --------------------------------------- |
| `session_id`      | string | yes      | Unique session identifier               |
| `cwd`             | string | yes      | Working directory when hook is invoked  |
| `transcript_path` | string | yes      | Path to conversation transcript         |
| `permission_mode` | string | yes      | Current permission mode                 |
| `hook_event_name` | string | yes      | Which hook fired (e.g., `Stop`)         |

All five common fields are **always present** â€” they are not optional. Some hook
events send additional fields (e.g., `tool_name` for `PreToolUse`), but ACD does
not use those.

ACD parses `session_id` and `cwd`. Unknown fields are silently ignored for
forward-compatibility with future Claude Code versions.

[hooks reference]: https://code.claude.com/docs/en/hooks

## Version Sync

The `build.rs` script generates `plugin.json` with the version from
`Cargo.toml`. If the versions diverge, the build fails. This ensures the plugin
version always matches the binary version.

## Uninstalling

```sh
# Remove plugin and system service
acd service uninstall

# Or remove only the plugin
claude plugin uninstall agent-console-dashboard
claude plugin marketplace remove PabloLION/agent-console-dashboard
```

## Troubleshooting

### Hooks Not Firing

- Verify the plugin is installed: `claude plugin list`
- Check `acd` is in PATH: `which acd`
- Verify Claude Code version supports plugins

### Dashboard Not Updating

- Confirm the daemon is running: `acd status`
- Test the hook subcommand manually:
  `echo '{"session_id":"test","cwd":"/tmp"}' | acd claude-hook attention`
- Check daemon logs for errors

### Manual Testing

```sh
# Start daemon
acd daemon &

# Simulate a Stop hook
echo '{"session_id":"test-session","cwd":"/tmp"}' | acd claude-hook attention

# Simulate a UserPromptSubmit hook
echo '{"session_id":"test-session","cwd":"/tmp"}' | acd claude-hook working

# Verify session appeared
acd status

# Clean up
acd set test-session closed
```

## Migration from Shell Scripts

If you previously used the shell script hooks (`scripts/hooks/*.sh`), remove
them and the corresponding entries from `~/.claude/settings.json`:

```sh
# Remove old hook scripts
rm -f ~/.claude/hooks/stop.sh
rm -f ~/.claude/hooks/user-prompt-submit.sh
rm -f ~/.claude/hooks/notification.sh

# Remove hook entries from settings.json (or edit manually)
# Then install the plugin
claude plugin marketplace add PabloLION/agent-console-dashboard
claude plugin install agent-console-dashboard
```

The plugin replaces all three shell scripts with the single `acd claude-hook`
binary subcommand. No `jq` or bash dependency required.
