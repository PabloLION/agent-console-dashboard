# Story: Restructure as Cargo Workspace

**Story ID:** S011.01 **Epic:**
[E011 - Claude Usage Crate](../epic/E011-claude-usage-crate.md) **Status:** Done
**Priority:** P0 **Estimated Points:** 2

## Description

As a developer, I want to restructure the project as a Cargo workspace, So that the `claude-usage` library crate can exist alongside the existing binary crate in a single repository.

## Context

The project currently has a single-crate structure (binary only). To publish the `claude-usage` library crate while maintaining the existing `agent-console-dashboard` binary, the repository must be converted to a Cargo workspace. This is the foundational change that enables all other E011 stories.

Workspace structure provides clean separation: the binary consumes the library like any other dependency, but both live in the same repo for unified development.

## Implementation Details

### Technical Approach

1. Create `crates/` directory at repository root
2. Move existing source code to `crates/agent-console-dashboard/`
3. Create `crates/claude-usage/` with initial `lib.rs`
4. Update root `Cargo.toml` to workspace manifest
5. Create individual `Cargo.toml` for each crate
6. Update file paths and imports if needed
7. Verify all tests still pass with `cargo test --workspace`

### Target Structure

```text
agent-console-dashboard/
├── Cargo.toml                    # workspace root
├── Cargo.lock                    # shared lockfile
├── crates/
│   ├── agent-console-dashboard/  # binary crate (existing code)
│   │   ├── Cargo.toml
│   │   └── src/
│   │       ├── main.rs
│   │       └── ...
│   └── claude-usage/             # library crate (new)
│       ├── Cargo.toml
│       └── src/
│           └── lib.rs
├── docs/
├── scripts/
└── ...
```

### Files to Create

- `crates/claude-usage/Cargo.toml` - Library crate manifest
- `crates/claude-usage/src/lib.rs` - Minimal placeholder library

### Files to Modify

- `Cargo.toml` - Convert from package manifest to workspace manifest
- `crates/agent-console-dashboard/Cargo.toml` - Create from root (move package section)

### Dependencies

None (first story in epic)

## Acceptance Criteria

- [ ] Given restructured workspace, when `cargo build --workspace` runs, then both crates compile successfully
- [ ] Given restructured workspace, when `cargo test --workspace` runs, then all existing tests pass
- [ ] Given binary crate, when built, then `acd` binary is produced with correct name
- [ ] Given library crate, when built, then `libclaude_usage.rlib` is produced
- [ ] Given workspace, when `cargo check --workspace` runs, then no errors or warnings

## Testing Requirements

- [ ] All existing unit tests pass after restructure
- [ ] All existing integration tests pass after restructure
- [ ] `cargo build --workspace --release` succeeds
- [ ] `cargo test --workspace` succeeds
- [ ] Binary runs correctly: `cargo run --bin acd -- --version`

## Out of Scope

- Implementing claude-usage functionality (subsequent stories)
- CI/CD pipeline updates (incremental)
- Publishing either crate (later story)

## Notes

### Root Cargo.toml (Workspace)

```toml
[workspace]
members = [
    "crates/agent-console-dashboard",
    "crates/claude-usage",
]
resolver = "2"

[workspace.package]
edition = "2021"
rust-version = "1.74"
license = "MIT OR Apache-2.0"
repository = "https://github.com/PabloLION/agent-console-dashboard"
```

### Binary Crate Cargo.toml

```toml
[package]
name = "agent-console-dashboard"
version = "0.1.0"
edition.workspace = true
license.workspace = true
repository.workspace = true

[[bin]]
name = "acd"
path = "src/main.rs"

[dependencies]
# ... existing dependencies ...
# Will add claude-usage later:
# claude-usage = { path = "../claude-usage" }
```

### Library Crate Cargo.toml (Initial)

```toml
[package]
name = "claude-usage"
version = "0.1.0"
edition.workspace = true
rust-version.workspace = true
description = "Fetch Claude API usage data from Anthropic OAuth endpoint"
license.workspace = true
repository.workspace = true
keywords = ["claude", "anthropic", "usage", "api", "oauth"]
categories = ["api-bindings", "authentication"]

[dependencies]
# Dependencies added in subsequent stories
```

### Initial lib.rs

```rust
// crates/claude-usage/src/lib.rs

//! Fetch Claude API usage data from Anthropic
//!
//! This crate provides a simple API to retrieve Claude usage data from the
//! Anthropic OAuth usage endpoint. It handles credential retrieval from
//! platform-specific secure storage and returns typed usage information.

#![warn(missing_docs)]

/// Placeholder - implementation in subsequent stories
pub fn placeholder() {
    todo!("Implementation in S011.02+")
}
```

### Migration Steps

```bash
# 1. Create workspace structure
mkdir -p crates/agent-console-dashboard crates/claude-usage/src

# 2. Move existing code to binary crate
git mv src crates/agent-console-dashboard/
git mv Cargo.toml crates/agent-console-dashboard/Cargo.toml.bak

# 3. Create new manifests
# (Create root Cargo.toml as workspace)
# (Create crates/agent-console-dashboard/Cargo.toml from .bak)
# (Create crates/claude-usage/Cargo.toml)

# 4. Create placeholder lib
echo 'pub fn placeholder() {}' > crates/claude-usage/src/lib.rs

# 5. Verify
cargo build --workspace
cargo test --workspace
cargo run --bin acd -- --version
```

### Validation Checklist

- [ ] Both crates compile without warnings
- [ ] All tests pass
- [ ] Binary runs and shows version
- [ ] Git history preserved for moved files
- [ ] No broken imports or path references
