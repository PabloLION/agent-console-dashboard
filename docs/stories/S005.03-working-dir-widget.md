# Story: Implement Working Directory Widget

**Story ID:** S005.03 **Epic:**
[E005 - Widget System](../epic/E005-widget-system.md) **Status:** Draft
**Priority:** P2 **Estimated Points:** 2

## Description

As a user, I want to see the current working directory of the selected session,
So that I can quickly identify which project I'm viewing.

## Context

The working-dir widget displays the working directory of the currently selected
session. It provides context about where the selected agent session is running,
which is especially useful when managing multiple projects simultaneously.

The widget handles path display intelligently, collapsing the home directory to
`~` and truncating long paths from the left to fit within terminal width
constraints.

## Implementation Details

### Technical Approach

1. Create `src/widgets/working_dir.rs`
2. Implement Widget trait for WorkingDirWidget
3. Replace home directory prefix with `~` for compact display
4. Truncate long paths from the left with `…/` prefix
5. Handle case when no session is selected (show placeholder)
6. Support optional styling (dimmed, colored based on context)

### Files to Modify

- `src/widgets/working_dir.rs` - WorkingDirWidget implementation
- `src/widgets/mod.rs` - Export and register working-dir widget

### Dependencies

- [S005.01 - Widget Trait/Interface](./S005.01-widget-trait-interface.md) - Widget
  trait to implement
- [S002.01 - Session Data Model](./S002.01-session-data-model.md) - Session struct
  with working_dir field

## Acceptance Criteria

- [ ] Given a session is selected, when widget renders, then the session's
      working directory is displayed
- [ ] Given the path starts with home directory, when displayed, then home is
      replaced with `~`
- [ ] Given the path exceeds available width, when displayed, then path is
      truncated from left with `…/`
- [ ] Given no session is selected, when widget renders, then a placeholder
      message is shown
- [ ] Given terminal width is very narrow, when displayed, then only the final
      directory name is shown
- [ ] Given the working directory exists, when widget renders, then path is
      normalized (no trailing slash)

## Testing Requirements

- [ ] Unit test: Home directory replacement works on various platforms
- [ ] Unit test: Path truncation preserves final directory name
- [ ] Unit test: Placeholder displays when no session selected
- [ ] Unit test: Various path lengths are handled correctly
- [ ] Unit test: Empty path is handled gracefully

## Out of Scope

- Clickable paths (terminal doesn't support)
- Path validation (checking if directory exists)
- Multiple paths for multi-session view
- Path editing or navigation

## Notes

### Display Examples

**Full path that fits:**

```text
~/projects/my-app
```

**Truncated long path:**

```text
…/deeply/nested/project
```

**Very narrow terminal (only final dir):**

```text
project
```

**No session selected:**

```text
(no session selected)
```

### Implementation

```rust
use ratatui::prelude::*;
use crate::widgets::{Widget, WidgetContext};
use std::path::Path;

pub struct WorkingDirWidget;

impl WorkingDirWidget {
    pub fn new() -> Self {
        Self
    }

    fn format_path(&self, path: &Path, max_width: u16) -> String {
        let mut display = self.collapse_home(path);

        if display.len() <= max_width as usize {
            return display;
        }

        // Truncate from left, keeping final component
        let final_name = path.file_name()
            .map(|n| n.to_string_lossy().to_string())
            .unwrap_or_default();

        if final_name.len() + 4 >= max_width as usize {
            // Just show final directory name
            return self.truncate_string(&final_name, max_width as usize);
        }

        // Calculate how much path we can show
        let available = max_width as usize - 2; // Reserve for "…/"

        // Try to show as much of the path from the end as possible
        let truncated = if display.len() > available {
            format!("…{}", &display[display.len() - available + 1..])
        } else {
            display
        };

        truncated
    }

    fn collapse_home(&self, path: &Path) -> String {
        if let Some(home) = dirs::home_dir() {
            if let Ok(relative) = path.strip_prefix(&home) {
                return format!("~/{}", relative.display());
            }
        }
        path.display().to_string()
    }

    fn truncate_string(&self, s: &str, max_len: usize) -> String {
        if s.len() <= max_len {
            s.to_string()
        } else if max_len <= 3 {
            s[..max_len].to_string()
        } else {
            format!("{}…", &s[..max_len - 1])
        }
    }
}

impl Widget for WorkingDirWidget {
    fn render(&self, width: u16, context: &WidgetContext) -> Line<'_> {
        let text = if let Some(idx) = context.selected_index {
            if let Some(session) = context.sessions.get(idx) {
                self.format_path(&session.working_dir, width)
            } else {
                "(no session selected)".to_string()
            }
        } else if let Some(first) = context.sessions.first() {
            // Default to first session if none selected
            self.format_path(&first.working_dir, width)
        } else {
            "(no sessions)".to_string()
        };

        Line::from(Span::styled(
            text,
            Style::default().fg(Color::Cyan),
        ))
    }

    fn id(&self) -> &'static str {
        "working-dir"
    }

    fn min_width(&self) -> u16 {
        20
    }
}
```

### Path Handling Edge Cases

| Input Path                             | Width | Output              |
| -------------------------------------- | ----- | ------------------- |
| `/home/user/projects/app`              | 40    | `~/projects/app`    |
| `/home/user/very/long/path/to/project` | 25    | `…/path/to/project` |
| `/home/user/deep/nested/project`       | 15    | `…/project`         |
| `/home/user/x`                         | 5     | `~/x`               |
| `/`                                    | 10    | `/`                 |

### Color Configuration

The working directory can optionally be styled based on context:

- Cyan (default): Normal display
- Dimmed: When session is closed
- Yellow: When session needs attention
