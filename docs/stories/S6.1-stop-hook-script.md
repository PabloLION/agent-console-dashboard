# Story: Create Stop Hook Script

**Story ID:** S6.1 **Epic:**
[E006 - Claude Code Integration](../epic/E006-claude-code-integration.md)
**Status:** Draft **Priority:** P1 **Estimated Points:** 2

## Description

As a user, I want a hook script that runs when Claude Code stops or completes,
So that my dashboard automatically shows which sessions need attention.

## Context

The Stop hook is fired by Claude Code whenever a session stops or completes its
work. This is a critical integration point because it signals that Claude has
finished processing and may be waiting for user input or has completed the task.
The dashboard should immediately reflect this state change by setting the
session status to "Attention".

The hook script must be portable, work with minimal dependencies (just bash and
the agent-console CLI), and correctly derive the project name from the current
working directory where Claude Code is running.

## Implementation Details

### Technical Approach

1. Create `scripts/hooks/stop.sh` (template for users to copy)
2. Script extracts project name from `$PWD` using `basename`
3. Script calls `agent-console set <project> attention` to update status
4. Script must be executable and use `/bin/bash` shebang
5. Include comments explaining usage and customization options

### Files to Modify

- `scripts/hooks/stop.sh` - Create the stop hook script template
- `scripts/hooks/README.md` - Document hook installation (if not exists)

### Dependencies

- [E001 - Daemon Core Infrastructure](../epic/E001-daemon-core-infrastructure.md)
  \- Daemon must be running
- [S3.2 - SET Command](./S3.2-set-command.md) - CLI SET command must work
- [S3.5 - CLI Client Commands](./S3.5-cli-client-commands.md) - agent-console
  CLI must be installed

## Acceptance Criteria

- [ ] Given the stop.sh script exists, when copied to `~/.claude/hooks/`, then
      it is ready to use
- [ ] Given Claude Code invokes the stop hook, when the script runs, then
      `agent-console set <project> attention` is called
- [ ] Given Claude Code is running in `/home/user/projects/my-app`, when stop
      hook fires, then project name is `my-app`
- [ ] Given the agent-console daemon is not running, when hook is invoked, then
      script fails gracefully (no crash)
- [ ] Given the script is examined, when read by a user, then comments explain
      how to customize and install it
- [ ] Given the script runs, when completed, then it exits with status 0 on
      success

## Testing Requirements

- [ ] Manual test: Copy script to `~/.claude/hooks/stop.sh` and verify it
      executes
- [ ] Manual test: Run script directly from a project directory and verify
      dashboard updates
- [ ] Manual test: Run script when daemon is not running to verify graceful
      failure
- [ ] Unit test: Script extracts correct project name from various directory
      paths

## Out of Scope

- Automatic installation of hook scripts (user copies manually)
- Integration with AskQuestion hook (not yet available in Claude Code)
- Custom project name derivation beyond `basename $PWD`
- Windows support (bash scripts only)

## Notes

### Script Template

```bash
#!/bin/bash
# Agent Console Dashboard - Stop Hook for Claude Code
#
# This script is invoked when a Claude Code session stops or completes.
# It sets the session status to "Attention" in the dashboard.
#
# Installation:
#   1. Copy this file to ~/.claude/hooks/stop.sh
#   2. Make it executable: chmod +x ~/.claude/hooks/stop.sh
#   3. Register in ~/.claude/settings.json (see S6.4)
#
# Customization:
#   - Modify PROJECT derivation for custom naming
#   - Add logging by appending to a log file
#   - Add notifications (e.g., terminal-notifier, notify-send)

PROJECT=$(basename "$PWD")
agent-console set "$PROJECT" attention
```

### Project Name Derivation

The script uses `basename "$PWD"` to derive the project name from the current
working directory. This assumes:

- Claude Code is always run from the project root
- Project directory name is a suitable identifier
- Multiple projects with the same directory name in different locations will
  conflict (known limitation)

### Error Handling

The script should not prevent Claude Code from operating if it fails. Consider:

- Using `|| true` to suppress error exit codes
- Logging errors to a file for debugging
- Timeout on agent-console call (in case daemon hangs)

### Future Enhancements

- Support for custom project name via environment variable
- Support for multiple dashboard instances
- Integration with system notifications
