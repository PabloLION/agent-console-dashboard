# Story: Create macOS launchd Plist

**Story ID:** S013.01 **Epic:**
[E013 - Deployment Infrastructure](../epic/E013-deployment-infrastructure.md)
**Status:** Draft **Priority:** P1 **Estimated Points:** 2

## Description

As a macOS user, I want a launchd plist file that runs the daemon as a
user-level service, So that the daemon starts automatically on login and
restarts on crash without manual intervention.

## Context

macOS uses launchd for service management. A plist file installed in
`~/Library/LaunchAgents/` runs as a user-level agent (no root required). The
daemon should start on login (`RunAtLoad`), restart on failure (`KeepAlive`),
and log output to XDG State Directory per E012 logging requirements.

Per the epic, this story creates the plist template. S013.03 implements the
`acd service install` command that copies this file to the correct location.

## Implementation Details

### Technical Approach

1. Create a launchd plist template with correct paths and settings
2. Use `RunAtLoad` for automatic startup on login
3. Use `KeepAlive` for crash recovery (auto-restart)
4. Route stderr to log file in XDG State Directory
5. Include the plist as a project resource in `resources/` directory

### Plist Template

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
  "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.agent-console.daemon</string>
    <key>ProgramArguments</key>
    <array>
        <string>/usr/local/bin/acd</string>
        <string>daemon</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
    <key>EnvironmentVariables</key>
    <dict>
        <key>HOME</key>
        <string>/Users/USERNAME</string>
    </dict>
    <key>StandardErrorPath</key>
    <string>/Users/USERNAME/.local/state/agent-console/acd.log</string>
</dict>
</plist>
```

### Files Created

- `resources/com.agent-console.daemon.plist` - launchd plist template

### Install Location

The plist will be installed to `~/Library/LaunchAgents/com.agent-console.daemon.plist`
by the `acd service install` command (S013.03).

### Dependencies

- [E001 - Daemon Core Infrastructure](../epic/E001-daemon-core-infrastructure.md) -
  Daemon binary must exist
- [E012 - Logging and Diagnostics](../epic/E012-logging-and-diagnostics.md) -
  Logging to file required for background service operation

## Acceptance Criteria

- [ ] Plist file is valid XML and passes `plutil -lint`
- [ ] `RunAtLoad` set to `true` for auto-start on login
- [ ] `KeepAlive` set to `true` for crash recovery
- [ ] `StandardErrorPath` set to full path (no tilde) for log file
- [ ] `ProgramArguments` uses `/usr/local/bin/acd daemon` (launchd manages
      process lifecycle)
- [ ] `HOME` environment variable set for XDG path resolution
- [ ] `launchctl load` succeeds when plist is copied to `~/Library/LaunchAgents/`
- [ ] Daemon starts automatically after `launchctl load`

## Testing Requirements

- [ ] Manual test: `plutil -lint resources/com.agent-console.daemon.plist`
      passes
- [ ] Manual test: copy plist to `~/Library/LaunchAgents/` and run
      `launchctl load`
- [ ] Manual test: verify daemon starts after load
- [ ] Manual test: kill daemon process, verify auto-restart
- [ ] Manual test: reboot/re-login, verify daemon starts
- [ ] Manual test: `launchctl unload` cleanly stops the service

## Out of Scope

- CLI install/uninstall command (see S013.03)
- Dynamic path substitution in plist (paths are hardcoded to standard locations)
- Log rotation configuration (use OS tools: `newsyslog`)
- Conditional execution based on network availability

## Notes

### Path Assumptions

The plist assumes:

- Binary installed at `/usr/local/bin/acd` (standard Homebrew location)
- Log directory exists at `~/.local/state/agent-console/` (created by daemon on
  startup per S012.01)
- User has write permissions to log directory

### launchd Process Management

When run via launchd, the daemon runs in foreground mode. launchd manages the
process lifecycle (fork, background execution) itself.

### KeepAlive Behavior

`KeepAlive=true` means launchd restarts the daemon if it exits for any reason
(crash, manual kill, etc.). To permanently stop the daemon, use
`launchctl unload` to unregister the service.

### Tilde Expansion in Plist

launchd does not reliably expand `~`. Use full paths with the HOME environment
variable set in the plist's EnvironmentVariables section. The `acd service
install` command substitutes the actual home directory path at install time.

### XDG Path Resolution

The plist sets `HOME` environment variable to ensure XDG path resolution works
correctly. The daemon uses `XDG_STATE_HOME` with fallback to
`$HOME/.local/state`, which works correctly since HOME is always available.

> **Note:** launchd plist only sets HOME. The daemon uses XDG_STATE_HOME with
> fallback to $HOME/.local/state, which works correctly since HOME is always
> available.
