# Story: Implement Session Status Transitions

**Story ID:** S2.2 **Epic:**
[E002 - Session Management](../epic/E002-session-management.md) **Status:**
Draft **Priority:** P1 **Estimated Points:** 3

## Description

As a developer, I want to implement validated session status transitions, So
that sessions can only move between valid states and invalid transitions are
rejected.

## Context

Session status transitions represent the core business logic of the session
management system. Each status change must be validated to ensure data integrity
and prevent invalid states. The transition logic also needs to update the
`since` timestamp and trigger history recording.

Status states and their meanings:

- **Working**: Agent is actively processing a task
- **Attention**: Agent has stopped and is waiting for user input
- **Question**: Agent has asked a question using AskUserQuestion tool
- **Closed**: Session has been terminated

These states are triggered by different Claude Code hooks:

- Working <- UserPromptSubmit hook
- Attention <- Stop hook, Notification hook
- Question <- AskQuestion hook (needs investigation)
- Closed <- Session termination

## Implementation Details

### Technical Approach

1. Define valid transition rules as a state machine
2. Implement `Session::set_status()` method with validation
3. Return error for invalid transitions (or decide to allow all transitions)
4. Update `since` field on successful transition
5. Calculate duration in previous state
6. Trigger history recording (calls into S2.3 implementation)
7. Handle special cases like transitioning to/from Closed

### Files to Modify

- `src/daemon/session.rs` - Add transition methods to Session
- `src/daemon/store.rs` - Add store method for status updates

### Dependencies

- [S2.1 - Session Data Model](./S2.1-session-data-model.md) - Data model must be
  defined first

## Acceptance Criteria

- [ ] Given a session in Working status, when transitioning to Attention, then
      the transition succeeds
- [ ] Given a session in Working status, when transitioning to Question, then
      the transition succeeds
- [ ] Given a session in any status, when transitioning to Closed, then the
      transition succeeds
- [ ] Given a session in Closed status, when transitioning to any other status,
      then the transition is rejected (session must be resurrected instead)
- [ ] Given any status transition, when it succeeds, then the `since` field is
      updated to current time
- [ ] Given any status transition, when it succeeds, then the duration in
      previous state is calculated
- [ ] Given any status transition, when it succeeds, then history recording is
      triggered
- [ ] Given a transition to the same status (e.g., Working -> Working), then it
      is treated as a no-op or refresh (configurable)

## Testing Requirements

- [ ] Unit test: All valid transitions succeed
- [ ] Unit test: Invalid transitions (from Closed) are rejected
- [ ] Unit test: `since` timestamp updates on transition
- [ ] Unit test: Duration calculation is accurate
- [ ] Unit test: Same-status transitions handled correctly
- [ ] Integration test: Transition triggers history recording

## Out of Scope

- State history storage implementation (S2.3)
- Lifecycle event emission (S2.4)
- Hook integration (E006)
- IPC command handling (E003)

## Notes

### Valid Transition Matrix

| From \ To | Working | Attention | Question | Closed |
| --------- | ------- | --------- | -------- | ------ |
| Working   | refresh | valid     | valid    | valid  |
| Attention | valid   | refresh   | valid    | valid  |
| Question  | valid   | valid     | refresh  | valid  |
| Closed    | invalid | invalid   | invalid  | -      |

Note: "refresh" means the transition is allowed but may be treated as a
timestamp update rather than a true state change.

### Design Decision: Strict vs Permissive Transitions

Two approaches are possible:

1. **Strict**: Only allow transitions that make semantic sense (e.g., Working ->
   Question but not Question -> Working without user input)
2. **Permissive**: Allow any non-Closed transition, trust the hooks to send
   valid states

**Recommendation:** Start permissive, as hooks are the source of truth. Add
validation later if issues arise.

### Timestamp Handling

```rust
impl Session {
    fn set_status(&mut self, new_status: Status) -> Result<Duration, TransitionError> {
        if self.status == Status::Closed && new_status != Status::Closed {
            return Err(TransitionError::SessionClosed);
        }

        let now = Instant::now();
        let duration = now.duration_since(self.since);
        let old_status = std::mem::replace(&mut self.status, new_status);
        self.since = now;

        // Record history (S2.3)
        self.record_transition(old_status, new_status, duration);

        Ok(duration)
    }
}
```
