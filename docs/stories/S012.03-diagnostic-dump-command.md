# Story: Add Diagnostic Dump Command

**Story ID:** S012.03 **Epic:**
[E012 - Logging and Diagnostics](../epic/E012-logging-and-diagnostics.md)
**Status:** Ready for Dev **Priority:** P3 **Estimated Points:** 3

## Description

As a developer debugging issues, I want to run `acd dump` to get a full JSON
snapshot of the daemon's internal state, So that I can inspect sessions, config,
and runtime details without connecting a debugger.

## Context

The health check command (S012.02) provides a high-level overview. The dump
command provides a detailed snapshot useful for bug reports and post-mortem
analysis. It serializes all daemon state (sessions, config, uptime, socket info)
as JSON to stdout.

## Implementation Details

### Technical Approach

1. Add `DUMP` IPC command to the socket server
2. Serialize full daemon state as JSON (sessions, config, uptime, socket path)
3. Add `dump` CLI subcommand that sends `DUMP` and prints the response
4. Output as JSON (default format)

### IPC Protocol

```text
DUMP
  Returns: OK <json>
  JSON payload: full daemon state including all sessions, config, uptime
```

### CLI Output (JSON)

```json
{
  "uptime_seconds": 9240,
  "socket_path": "/tmp/agent-console.sock",
  "sessions": [
    {
      "id": "abc123",
      "status": "Working",
      "working_dir": "/home/user/project"
    }
  ],
  "session_counts": {
    "active": 3,
    "closed": 1
  }
}
```

### Files to Modify

- `crates/agent-console-dashboard/src/main.rs` — add `Dump` subcommand
- `crates/agent-console-dashboard/src/daemon/server.rs` — add `DUMP` command
  handler
- `crates/agent-console-dashboard/src/lib.rs` — add `DaemonDump` response type

### Dependencies

- [S012.02 - Health Check Command](./S012.02-health-check-command.md) — shares
  IPC infrastructure and uptime tracking

## Acceptance Criteria

- [ ] `acd dump` outputs full daemon state as JSON
- [ ] Output includes: all sessions, session counts, uptime, socket path
- [ ] Output is valid JSON
- [ ] Exit code 0 when daemon is running, 1 when unreachable
- [ ] `DUMP` IPC command returns complete state
- [ ] `cargo test --workspace` passes
- [ ] `cargo clippy --workspace` passes

## Testing Requirements

- [ ] Unit test: `DUMP` command handler returns valid JSON
- [ ] Unit test: dump response includes all session data
- [ ] Unit test: JSON output is parseable by `serde_json`
- [ ] Manual test: `acd dump` with daemon running
- [ ] Manual test: `acd dump` with daemon stopped (exit code 1)

## Out of Scope

- `--format text` human-readable output (defer to future enhancement)
- Filtering dump output by section
- Memory usage or OS-level process info
- Streaming dump updates

## Notes

### DaemonDump Type

```rust
#[derive(Debug, serde::Serialize, serde::Deserialize)]
pub struct DaemonDump {
    pub uptime_seconds: u64,
    pub socket_path: String,
    pub sessions: Vec<SessionSnapshot>,
    pub session_counts: SessionCounts,
}

#[derive(Debug, serde::Serialize, serde::Deserialize)]
pub struct SessionSnapshot {
    pub id: String,
    pub status: String,
    pub working_dir: String,
}
```
