# Story: Implement API Usage Widget

**Story ID:** S5.4 **Epic:**
[E005 - Widget System](../epic/E005-widget-system.md) **Status:** Draft
**Priority:** P2 **Estimated Points:** 3

## Description

As a user, I want to see my API usage (tokens and estimated cost) in the
dashboard, So that I can monitor my resource consumption across agent sessions.

## Context

The api-usage widget displays aggregated API usage metrics including token
counts (input/output) and estimated cost. This helps users track their resource
consumption, especially important for users with usage-based billing or budget
constraints.

The widget can show either session-specific usage (for the selected session) or
aggregated usage across all sessions, depending on configuration and available
data.

## Implementation Details

### Technical Approach

1. Create `src/widgets/api_usage.rs`
2. Implement Widget trait for ApiUsageWidget
3. Format token counts with human-readable suffixes (k, M)
4. Calculate and display estimated cost based on token counts
5. Handle missing API data gracefully (show placeholder)
6. Support compact and detailed display modes
7. Apply color coding for usage thresholds

### Files to Modify

- `src/widgets/api_usage.rs` - ApiUsageWidget implementation
- `src/widgets/mod.rs` - Export and register api-usage widget

### Dependencies

- [S5.1 - Widget Trait/Interface](./S5.1-widget-trait-interface.md) - Widget
  trait to implement
- [S9.1 - API Usage Data Model](./S9.1-api-usage-data-model.md) - ApiUsage
  struct definition (E009)

## Acceptance Criteria

- [ ] Given API usage data is available, when widget renders, then token counts
      are displayed
- [ ] Given token counts are large, when displayed, then human-readable suffixes
      are used (12.3k, 1.2M)
- [ ] Given API usage data is available, when widget renders, then estimated
      cost is displayed with currency symbol
- [ ] Given no API usage data is available, when widget renders, then a
      placeholder message is shown
- [ ] Given terminal width is limited, when widget renders, then display is
      abbreviated
- [ ] Given high usage, when widget renders, then warning color (yellow/red) is
      applied

## Testing Requirements

- [ ] Unit test: Token count formatting with various magnitudes (100, 1000,
      100000, 1000000)
- [ ] Unit test: Cost estimation calculation is accurate
- [ ] Unit test: Placeholder displays when no API data available
- [ ] Unit test: Width constraint handling with abbreviation
- [ ] Unit test: Color thresholds are applied correctly

## Out of Scope

- Historical usage graphs (future enhancement)
- Per-model cost breakdown
- Usage alerts or notifications
- Cost predictions
- Usage reset or period selection

## Notes

### Display Format

**Full format:**

```text
Tokens: 12.3k in / 8.1k out | $0.42 est
```

**Compact format (narrow terminal):**

```text
12.3k/8.1k | $0.42
```

**No data available:**

```text
API usage: --
```

### Token Formatting

```rust
fn format_tokens(count: u64) -> String {
    if count < 1000 {
        format!("{}", count)
    } else if count < 1_000_000 {
        format!("{:.1}k", count as f64 / 1000.0)
    } else {
        format!("{:.1}M", count as f64 / 1_000_000.0)
    }
}
```

### Cost Estimation

Cost is estimated based on typical Claude API pricing:

- Input tokens: $0.008 per 1k tokens (example rate)
- Output tokens: $0.024 per 1k tokens (example rate)

```rust
fn estimate_cost(input_tokens: u64, output_tokens: u64) -> f64 {
    let input_cost = (input_tokens as f64 / 1000.0) * 0.008;
    let output_cost = (output_tokens as f64 / 1000.0) * 0.024;
    input_cost + output_cost
}
```

### Implementation

```rust
use ratatui::prelude::*;
use crate::widgets::{Widget, WidgetContext};
use crate::api_usage::ApiUsage;

pub struct ApiUsageWidget {
    mode: DisplayMode,
}

#[derive(Clone, Copy)]
pub enum DisplayMode {
    Full,
    Compact,
}

impl ApiUsageWidget {
    pub fn new() -> Self {
        Self {
            mode: DisplayMode::Full,
        }
    }

    fn format_full(&self, usage: &ApiUsage) -> Line<'_> {
        let input = format_tokens(usage.input_tokens);
        let output = format_tokens(usage.output_tokens);
        let cost = estimate_cost(usage.input_tokens, usage.output_tokens);

        let cost_color = if cost > 10.0 {
            Color::Red
        } else if cost > 5.0 {
            Color::Yellow
        } else {
            Color::Green
        };

        Line::from(vec![
            Span::raw("Tokens: "),
            Span::styled(input, Style::default().fg(Color::Cyan)),
            Span::raw(" in / "),
            Span::styled(output, Style::default().fg(Color::Cyan)),
            Span::raw(" out | "),
            Span::styled(format!("${:.2} est", cost), Style::default().fg(cost_color)),
        ])
    }

    fn format_compact(&self, usage: &ApiUsage) -> Line<'_> {
        let input = format_tokens(usage.input_tokens);
        let output = format_tokens(usage.output_tokens);
        let cost = estimate_cost(usage.input_tokens, usage.output_tokens);

        Line::from(vec![
            Span::styled(format!("{}/{}", input, output), Style::default().fg(Color::Cyan)),
            Span::raw(" | "),
            Span::styled(format!("${:.2}", cost), Style::default().fg(Color::Green)),
        ])
    }
}

impl Widget for ApiUsageWidget {
    fn render(&self, width: u16, context: &WidgetContext) -> Line<'_> {
        match context.api_usage {
            Some(usage) => {
                if width < 30 {
                    self.format_compact(usage)
                } else {
                    self.format_full(usage)
                }
            }
            None => {
                Line::from(Span::styled(
                    "API usage: --",
                    Style::default().fg(Color::DarkGray),
                ))
            }
        }
    }

    fn id(&self) -> &'static str {
        "api-usage"
    }

    fn min_width(&self) -> u16 {
        25
    }
}
```

### Usage Thresholds and Colors

| Cost Range | Color  | Meaning        |
| ---------- | ------ | -------------- |
| $0 - $5    | Green  | Normal usage   |
| $5 - $10   | Yellow | Elevated usage |
| $10+       | Red    | High usage     |

These thresholds are configurable in the future.

### API Usage Data Source

API usage data can come from:

1. Claude Code hooks reporting token counts
2. Session metadata if available
3. Aggregated from daemon's in-memory store

The widget gracefully handles missing data - it's optional information that
enhances the dashboard but isn't required for core functionality.
