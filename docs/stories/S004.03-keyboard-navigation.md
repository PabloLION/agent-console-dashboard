# Story: Add Keyboard Navigation

**Story ID:** S004.03 **Epic:**
[E004 - TUI Dashboard](../epic/E004-tui-dashboard.md) **Status:** Draft
**Priority:** P1 **Estimated Points:** 3

## Description

As a user, I want to navigate between sessions using keyboard shortcuts, So that
I can quickly select and interact with sessions without using a mouse.

## Context

Keyboard-driven navigation is essential for a terminal application. Users expect
vim-style navigation (j/k for up/down) and standard shortcuts (Enter to select,
q to quit). This story implements the core navigation and quick action shortcuts
that work from the main dashboard view.

The keyboard shortcuts follow terminal application conventions and are
documented in the footer of the TUI for discoverability.

## Implementation Details

### Technical Approach

1. Extend event handler to process keyboard input
2. Implement session selection state (highlighted row)
3. Add j/k navigation for moving selection up/down
4. Implement Enter to expand detail view (triggers S004.04)
5. Add quick actions: r (resurrect), d (remove)
6. Implement layout switching with number keys 1-4
7. Add ? for help overlay and q for quit
8. Support arrow keys as alternative to j/k

### Files to Modify

- `src/tui/event.rs` - Add keyboard event handlers
- `src/tui/app.rs` - Add selection state, action handlers
- `src/tui/views/dashboard.rs` - Highlight selected session
- `src/tui/ui.rs` - Update render to show selection

### Dependencies

- [S004.01 - Ratatui Application Scaffold](./S004.01-ratatui-application-scaffold.md) -
  Event loop infrastructure
- [S004.02 - Main Dashboard Layout](./S004.02-main-dashboard-layout.md) - Session list
  rendering
- [S008.02 - RESURRECT Command](./S008.02-resurrect-command.md) - For resurrect action
  (optional, can stub)

## Acceptance Criteria

- [ ] Given multiple sessions exist, when `j` is pressed, then selection moves
      down
- [ ] Given multiple sessions exist, when `k` is pressed, then selection moves
      up
- [ ] Given selection at first session, when `k` is pressed, then selection
      stays at first (no wrap)
- [ ] Given selection at last session, when `j` is pressed, then selection stays
      at last (no wrap)
- [ ] Given a session is selected, when `Enter` is pressed, then detail view
      opens (S004.04)
- [ ] Given a closed session is selected, when `r` is pressed, then resurrect
      action is triggered
- [ ] Given a session is selected, when `d` is pressed, then remove confirmation
      is shown
- [ ] Given TUI is running, when `1-4` is pressed, then corresponding layout
      preset activates
- [ ] Given TUI is running, when `?` is pressed, then help overlay appears
- [ ] Given TUI is running, when `q` is pressed, then application exits cleanly
- [ ] Given arrow keys (↑/↓), when pressed, then they function same as k/j

## Testing Requirements

- [ ] Unit test: Selection moves correctly with j/k
- [ ] Unit test: Selection bounds checking prevents out-of-range
- [ ] Unit test: Key mapping correctly routes to actions
- [ ] Integration test: Full navigation flow from start to session selection
- [ ] Integration test: Quick actions trigger correct IPC commands

## Out of Scope

- Detail view implementation (S004.04)
- Widget customization UI (E005)
- Mouse support (future enhancement)
- Custom keybinding configuration (future enhancement)

## Notes

### Keyboard Shortcuts Reference

| Key       | Action                    | Context                 |
| --------- | ------------------------- | ----------------------- |
| `j` / `↓` | Move selection down       | Main view               |
| `k` / `↑` | Move selection up         | Main view               |
| `Enter`   | Open detail view          | Session selected        |
| `r`       | Resurrect session         | Closed session selected |
| `d`       | Remove session            | Any session selected    |
| `1`       | Switch to one-line layout | Any                     |
| `2`       | Switch to two-line layout | Any                     |
| `3`       | Switch to detailed layout | Any                     |
| `4`       | Switch to history layout  | Any                     |
| `?`       | Show help                 | Any                     |
| `q`       | Quit                      | Any                     |
| `Esc`     | Close overlay/go back     | Detail view, help       |

### Selection State

```rust
pub struct App {
    sessions: Vec<Session>,
    selected_index: usize,
    // ...
}

impl App {
    pub fn select_next(&mut self) {
        if self.selected_index < self.sessions.len().saturating_sub(1) {
            self.selected_index += 1;
        }
    }

    pub fn select_previous(&mut self) {
        self.selected_index = self.selected_index.saturating_sub(1);
    }

    pub fn selected_session(&self) -> Option<&Session> {
        self.sessions.get(self.selected_index)
    }
}
```

### Event Handling Pattern

```rust
use crossterm::event::{KeyCode, KeyEvent};

pub fn handle_key_event(app: &mut App, key: KeyEvent) -> Action {
    match key.code {
        KeyCode::Char('j') | KeyCode::Down => {
            app.select_next();
            Action::None
        }
        KeyCode::Char('k') | KeyCode::Up => {
            app.select_previous();
            Action::None
        }
        KeyCode::Enter => {
            Action::OpenDetail(app.selected_index)
        }
        KeyCode::Char('r') => {
            if let Some(session) = app.selected_session() {
                if session.status == Status::Closed {
                    Action::Resurrect(session.id.clone())
                } else {
                    Action::None
                }
            } else {
                Action::None
            }
        }
        KeyCode::Char('q') => Action::Quit,
        KeyCode::Char('?') => Action::ShowHelp,
        KeyCode::Char(c @ '1'..='4') => {
            let layout = c.to_digit(10).unwrap() as usize - 1;
            Action::SwitchLayout(layout)
        }
        _ => Action::None,
    }
}
```

### Visual Selection Indicator

The selected session should be visually distinct:

- Background highlight (inverse colors)
- Or prefix with `>` marker
- Selection should be visible even in minimal layouts

```text
  Sessions:
  ● proj-a      Working      ~/projects/proj-a
> ○ proj-b      Attention    ~/projects/proj-b      2m34s  ← selected
  ? proj-c      Question     ~/projects/proj-c
```
