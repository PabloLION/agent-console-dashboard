# Story: Create Linux systemd Unit File

**Story ID:** S013.02 **Epic:**
[E013 - Deployment Infrastructure](../epic/E013-deployment-infrastructure.md)
**Status:** Draft **Priority:** P1 **Estimated Points:** 2

## Description

As a Linux user, I want a systemd unit file that runs the daemon as a user-level
service, So that the daemon starts automatically on login and restarts on
failure with backoff delay.

## Context

Linux uses systemd for service management. A user-level unit file installed in
`~/.config/systemd/user/` runs without root privileges. The daemon should start
on login (`WantedBy=default.target`), restart on failure with backoff
(`Restart=on-failure`, `RestartSec=5`), and log output to XDG State Directory
per E012 logging requirements.

Per the epic, this story creates the unit file template. S013.03 implements the
`acd service install` command that copies this file to the correct location.

## Implementation Details

### Technical Approach

1. Create a systemd user unit file with correct settings
2. Use `Type=simple` (daemon runs in foreground for systemd)
3. Configure restart-on-failure with 5-second delay
4. Include the unit file as a project resource in `resources/` directory

### Unit File

```ini
[Unit]
Description=Agent Console Dashboard Daemon
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/acd daemon
Restart=on-failure
RestartSec=5

[Install]
WantedBy=default.target
```

### Files Created

- `resources/acd.service` - systemd user unit file

### Install Location

The unit file will be installed to `~/.config/systemd/user/acd.service` by the
`acd service install` command (S013.03).

### Dependencies

- [E001 - Daemon Core Infrastructure](../epic/E001-daemon-core-infrastructure.md) -
  Daemon binary must exist
- [E012 - Logging and Diagnostics](../epic/E012-logging-and-diagnostics.md) -
  Logging to file required for background service operation

## Acceptance Criteria

- [ ] Unit file passes `systemd-analyze verify` (if available)
- [ ] `Type=simple` set (daemon runs in foreground)
- [ ] `Restart=on-failure` configured
- [ ] `RestartSec=5` for 5-second backoff delay
- [ ] `WantedBy=default.target` for auto-start on login
- [ ] `systemctl --user enable acd` succeeds when unit file is copied to
      `~/.config/systemd/user/`
- [ ] Daemon starts automatically after enable
- [ ] Daemon restarts after failure with 5-second delay

## Testing Requirements

- [ ] Manual test: `systemd-analyze verify resources/acd.service` passes (if
      tool available)
- [ ] Manual test: copy unit file to `~/.config/systemd/user/` and run
      `systemctl --user enable acd`
- [ ] Manual test: verify daemon starts after enable
- [ ] Manual test: `systemctl --user start acd` starts the daemon
- [ ] Manual test: kill daemon process, verify restart after 5 seconds
- [ ] Manual test: re-login, verify daemon starts
- [ ] Manual test: `systemctl --user stop acd` cleanly stops the service
- [ ] Manual test: `systemctl --user disable acd` removes auto-start

## Out of Scope

- CLI install/uninstall command (see S013.03)
- System-level (root) service configuration
- Socket activation
- Journal log configuration (systemd captures stdout/stderr automatically)
- Dynamic path substitution in unit file

## Notes

### Path Assumptions

The unit file assumes:

- Binary installed at `/usr/local/bin/acd` (standard location)
- Log directory created by daemon on startup (per S012.01)
- User has write permissions to `~/.local/state/agent-console/`

### systemd vs Daemonize

When run via systemd, the daemon does NOT use the `--daemonize` flag. systemd
manages the process lifecycle itself. The daemon runs in foreground mode
(`Type=simple`) relative to systemd.

### Restart Behavior

`Restart=on-failure` means systemd restarts the daemon only when it exits with
non-zero status or crashes. Normal shutdown (exit code 0) does not trigger
restart. To permanently stop the daemon, use `systemctl --user stop acd` or
`systemctl --user disable acd`.

### RestartSec Rationale

5-second delay prevents rapid restart loops if the daemon has a persistent
configuration error or startup failure. This aligns with the epic's requirement
for backoff delay.

### Logging

systemd automatically captures stdout/stderr to the journal. The daemon's
structured logging (E012) outputs to both stderr (captured by systemd) and file
(for XDG State Directory persistence). Users can view logs via
`journalctl --user -u acd` or by reading `~/.local/state/agent-console/acd.log`.
