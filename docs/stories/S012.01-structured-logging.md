# Story: Add Structured Logging to Daemon

**Story ID:** S012.01 **Epic:**
[E012 - Logging and Diagnostics](../epic/E012-logging-and-diagnostics.md)
**Status:** Done **Priority:** P1 **Estimated Points:** 2

## Description

As a developer running the daemon, I want structured log output with
configurable levels, So that I can diagnose connection failures, state
transitions, and hook errors without adding ad-hoc print statements.

## Context

The daemon already uses `tracing` macros (`info!`, `debug!`, `warn!`, `error!`)
throughout `server.rs`, but there is no subscriber initialized — the log calls
are silently dropped at runtime. The `daemon/mod.rs` startup path uses raw
`eprintln!` calls instead of the tracing system.

This story wires up `tracing-subscriber` so all existing `tracing` calls produce
output, replaces the `eprintln!` calls with proper `tracing` macros, and adds
`ACD_LOG` environment variable support for runtime level control.

## Implementation Details

### Technical Approach

1. Add `tracing-subscriber` dependency with `env-filter` feature
2. Create `logging::init()` function that:
   - Reads `ACD_LOG` env var (falls back to `info`)
   - Configures a `fmt` subscriber writing to stderr
   - For daemonized mode, configures file output (deferred — stderr is enough
     for v0 since daemonize redirects to /dev/null; file output is a future E007
     concern)
3. Call `logging::init()` at the top of `run_daemon()` before any other work
4. Replace all `eprintln!` in `daemon/mod.rs` with `tracing` macros
5. Add structured fields where useful (socket path, config values)

### Files to Modify

- `crates/agent-console-dashboard/Cargo.toml` — add `tracing-subscriber`
  dependency
- `crates/agent-console-dashboard/src/daemon/mod.rs` — add `logging` submodule,
  call `init()`, replace `eprintln!` with tracing macros
- `crates/agent-console-dashboard/src/daemon/logging.rs` — new file: subscriber
  init

### Dependencies

- None (E001 daemon infrastructure already exists)

## Acceptance Criteria

- [ ] `tracing-subscriber` added with `env-filter` and `fmt` features
- [ ] `ACD_LOG=debug acd daemon` produces debug-level output to stderr
- [ ] Default log level is `info` when `ACD_LOG` is not set
- [ ] All `eprintln!` in `daemon/mod.rs` replaced with `tracing` macros
- [ ] Daemon startup logs socket path and daemonize flag at `info` level
- [ ] Shutdown signal logged at `info` level
- [ ] Existing `tracing` calls in `server.rs` now produce visible output
- [ ] `cargo test --workspace` passes
- [ ] `cargo clippy --workspace` passes

## Testing Requirements

- [ ] Unit test: `logging::init()` does not panic
- [ ] Unit test: verify `EnvFilter` parses valid directives
- [ ] Manual test: run `acd daemon` and observe info-level startup log
- [ ] Manual test: run `ACD_LOG=debug acd daemon` and observe debug output

## Out of Scope

- File-based log output (requires E007 config system)
- Log rotation
- JSON-formatted logs
- Metrics or spans beyond basic event logging

## Notes

### Subscriber Configuration

```rust
use tracing_subscriber::{fmt, EnvFilter};

pub fn init() {
    let filter = EnvFilter::try_from_env("ACD_LOG")
        .unwrap_or_else(|_| EnvFilter::new("info"));

    fmt()
        .with_env_filter(filter)
        .with_target(false)
        .with_writer(std::io::stderr)
        .init();
}
```

### Log Level Mapping

| Level | What gets logged                                                      |
| ----- | --------------------------------------------------------------------- |
| error | Fatal conditions, bugs                                                |
| warn  | Client handler errors, SIGTERM handler failures                       |
| info  | Startup, shutdown, socket binding, connection events                  |
| debug | Client connects/disconnects, command processing, stale socket cleanup |
| trace | Raw IPC message content (future)                                      |
