# Story: Create CLI Client Commands

**Story ID:** S003.05 **Epic:**
[E003 - IPC Protocol & Client](../epic/E003-ipc-protocol-and-client.md)
**Status:** Draft **Priority:** P1 **Estimated Points:** 5

## Description

As a user or hook script, I want CLI commands to interact with the daemon, So
that I can manage sessions and query state from the terminal.

## Context

While the daemon handles the protocol internally, users and hook scripts need a
friendly CLI interface. The `agent-console` binary provides subcommands that map
to IPC protocol commands. This abstraction layer:

- Provides a clean user experience with argument parsing
- Handles connection management (connect, send, receive, close)
- Formats output for human readability (or JSON for scripts)
- Auto-starts the daemon if not running (see S001.04)

These commands are used by hook scripts (set, rm) and by users for
debugging/monitoring (list, watch).

## Implementation Details

### Technical Approach

1. Create `crates/agent-console-dashboard/src/client/mod.rs` for client module
2. Create `crates/agent-console-dashboard/src/client/commands.rs` for command
   implementations
3. Add subcommands to main CLI using clap
4. Implement socket connection helper (connect to daemon)
5. Implement each command (set, rm, list, watch, resurrect)
6. Handle output formatting (human-readable vs JSON)

### CLI Commands

```bash
# Update session status (called by hooks)
agent-console set <session> <status>
agent-console set <session> <status> --cwd /path --session-id claude-abc

# Remove session
agent-console rm <session>

# Query all sessions (one-shot)
agent-console list
agent-console list --json  # Machine-readable output

# Subscribe to updates (streaming)
agent-console watch

# Resurrect closed session
agent-console resurrect <session>
```

Note: There is no `api-usage` CLI command. Usage data flows through the daemon
broadcast mechanism (D3), not through CLI commands.

### Files to Modify

- `crates/agent-console-dashboard/src/main.rs` - Add client subcommands to CLI
- `crates/agent-console-dashboard/src/client/mod.rs` - Create client module
- `crates/agent-console-dashboard/src/client/commands.rs` - Implement command
  functions
- `crates/agent-console-dashboard/src/client/connection.rs` - Socket connection
  helper

### Dependencies

- [S001.01 - Create Daemon Process](./S001.01-create-daemon-process.md) - CLI
  structure
- [S001.04 - Daemon Auto-Start](./S001.04-daemon-auto-start.md) - Auto-start if
  needed
- [S003.01 - IPC Message Protocol](./S003.01-ipc-message-protocol.md) - Protocol
  to use
- [S003.02 - SET Command](./S003.02-set-command.md) - Server-side handler
- [S003.03 - LIST Command](./S003.03-list-command.md) - Server-side handler
- [S003.04 - SUBSCRIBE Command](./S003.04-subscribe-command.md) - Server-side
  handler

## Acceptance Criteria

- [ ] Given `agent-console set <session> working`, then sends SET command and
      outputs "OK"
- [ ] Given `agent-console set` with invalid status, then shows error message
      and exits with code 1
- [ ] Given `agent-console rm <session>`, then sends RM command and outputs "OK"
- [ ] Given `agent-console list`, then outputs human-readable session list
- [ ] Given `agent-console list --json`, then outputs JSON array for scripting
- [ ] Given `agent-console watch`, then streams UPDATE messages until Ctrl+C
- [ ] Given daemon not running, when any command is run, then daemon auto-starts
- [ ] Given connection failure, then shows helpful error message

## Testing Requirements

- [ ] Unit test: CLI argument parsing for all commands
- [ ] Unit test: Connection helper handles daemon not running
- [ ] Integration test: `set` command updates session in daemon
- [ ] Integration test: `list` command returns current sessions
- [ ] Integration test: `watch` command receives real-time updates
- [ ] Integration test: Commands exit with appropriate codes (0 success, 1
      error)

## Out of Scope

- TUI dashboard (separate epic E004)
- Configuration file support (E007)
- Shell completion scripts (future enhancement)
- Man page documentation (future enhancement)

## Notes

### Project Structure

```text
src/
├── main.rs           # CLI entry point
├── client/
│   ├── mod.rs        # Module exports
│   ├── commands.rs   # Command implementations
│   └── connection.rs # Socket connection helper
```

### Command Implementations

Using **JSON Lines protocol** per
[D2](../architecture/2026-01-31-discussion-decisions.md):

```rust
// src/client/commands.rs
pub async fn set(session: &str, status: &str, cwd: Option<&str>) -> Result<()> {
    let mut conn = connect_to_daemon().await?;

    // Build JSON Lines command
    let cmd = serde_json::json!({
        "type": "SET",
        "session": session,
        "status": status,
        "metadata": cwd.map(|p| serde_json::json!({"cwd": p}))
    });
    conn.send_json(&cmd).await?;

    let response: Response = conn.recv_json().await?;
    match response {
        Response::Ok { .. } => Ok(()),
        Response::Error { message } => Err(anyhow!(message)),
        _ => Err(anyhow!("unexpected response")),
    }
}

pub async fn list(json: bool) -> Result<()> {
    let mut conn = connect_to_daemon().await?;
    conn.send_json(&serde_json::json!({"type": "LIST"})).await?;
    let response: Response = conn.recv_json().await?;
    // Parse STATE response and format output
}

pub async fn watch() -> Result<()> {
    let mut conn = connect_to_daemon().await?;
    conn.send_json(&serde_json::json!({"type": "SUBSCRIBE"})).await?;
    // Loop reading and printing UPDATE messages (JSON Lines stream)
}
```

### Output Formatting

**Human-readable (default):**

```text
Sessions:
  session-abc123  working    45s   /home/user/project
  session-def456  attention  2m    /home/user/other
```

**JSON (`--json` flag):**

```json
[{ "id": "session-abc123", "status": "working", "elapsed": 45 }]
```

### Error Messages

- "Error: daemon not running (and auto-start failed)"
- "Error: connection refused"
- "Error: invalid status 'foo' (expected: working, attention)"
- "Error: session 'xyz' not found"

### CLI Flag Naming

> **Note:** The CLI accepts `--cwd` as the flag name (matching Claude Code's
> JSON field). Internally this maps to `working_dir: PathBuf` in the Session
> struct.

### Exit Codes

| Code | Meaning                                       |
| ---- | --------------------------------------------- |
| 0    | Success                                       |
| 1    | Error (invalid arguments, daemon error, etc.) |
| 130  | Interrupted (Ctrl+C during watch)             |
