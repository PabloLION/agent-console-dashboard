# Story: Create Ratatui Application Scaffold

**Story ID:** S004.01 **Epic:**
[E004 - TUI Dashboard](../epic/E004-tui-dashboard.md) **Status:** Draft
**Priority:** P1 **Estimated Points:** 5

## Description

As a developer, I want to create a Ratatui application scaffold with proper
terminal initialization, So that I have a foundation for building the
interactive TUI dashboard.

## Context

The TUI dashboard is the primary user interface for the Agent Console Dashboard.
It needs to be built on Ratatui (a Rust library for building terminal user
interfaces) with Crossterm as the terminal backend. This scaffold establishes
the basic application structure including terminal setup/teardown, the main
event loop, and proper panic handling to ensure terminal state is always
restored.

The scaffold follows the standard Ratatui application pattern with:

- Raw mode terminal configuration
- Alternate screen buffer
- Event-driven architecture with Tokio async runtime
- `tokio::select!` event loop multiplexing terminal events and daemon updates
- Clean shutdown handling

## Implementation Details

### Technical Approach

1. Add Ratatui and Crossterm dependencies to Cargo.toml
2. Create `tui/mod.rs` module structure
3. Implement terminal initialization (raw mode, alternate screen)
4. Create application state struct to hold TUI state
5. Implement main event loop with `tokio::select!` for multiplexing:
   - Terminal input events (keyboard, resize) via crossterm
   - Daemon subscription updates via socket
   - UI refresh tick (250ms default, configurable via `[ui] tick_rate`)
6. Add panic hook to restore terminal state on crashes
7. Implement clean shutdown with terminal restoration

### Files to Modify

- `Cargo.toml` - Add ratatui, crossterm dependencies
- `crates/agent-console-dashboard/src/main.rs` - Add `tui` subcommand
- `crates/agent-console-dashboard/src/tui/mod.rs` - TUI module entry point
- `crates/agent-console-dashboard/src/tui/app.rs` - Application state and main
  loop
- `crates/agent-console-dashboard/src/tui/event.rs` - Event handling
  infrastructure

### Dependencies

- [S001.01 - Create Daemon Process](./S001.01-create-daemon-process.md) - Shares
  CLI entry point
- [S003.01 - IPC Message Protocol](./S003.01-ipc-message-protocol.md) - Will
  need IPC client for daemon connection

## Acceptance Criteria

- [ ] Given the TUI is started, when terminal is accessed, then raw mode is
      enabled and alternate screen is active
- [ ] Given the TUI is running, when `q` is pressed, then the application exits
      cleanly and terminal is restored
- [ ] Given the TUI is running, when a panic occurs, then the panic hook
      restores terminal state before crashing
- [ ] Given the TUI is running, when terminal resize event occurs, then the
      application receives the resize event
- [ ] Given the TUI is started, then startup time is under 100ms
- [ ] Given the TUI exits, then no terminal corruption occurs (cursor visible,
      echo enabled)
- [ ] Given the event loop runs, when multiplexing via `tokio::select!`, then
      terminal events and daemon updates are processed correctly

## Testing Requirements

- [ ] Unit test: Application state initializes correctly
- [ ] Unit test: Event channel creation succeeds
- [ ] Integration test: TUI starts and exits cleanly in CI environment
- [ ] Integration test: Panic hook restores terminal (spawn subprocess, force
      panic)

## Out of Scope

- Main dashboard layout rendering (S004.02)
- Keyboard navigation (S004.03)
- Session detail view (S004.04)
- Widget system integration (E005)
- Actual daemon connection (deferred to S004.02)

## Notes

### Project Structure

```text
src/
├── main.rs              # CLI entry, tui subcommand added
├── tui/
│   ├── mod.rs           # TUI module entry, re-exports
│   ├── app.rs           # Application state, event loop
│   └── event.rs         # Event handling (keyboard, resize, tick)
```

### Key Dependencies

| Crate     | Version | Purpose          |
| --------- | ------- | ---------------- |
| ratatui   | 0.26+   | TUI framework    |
| crossterm | 0.27+   | Terminal backend |
| tokio     | 1.x     | Async runtime    |

### CLI Interface

```bash
# Start TUI dashboard (foreground)
agent-console tui

# Start with specific layout
agent-console tui --layout detailed

# Start with custom socket path
agent-console tui --socket /tmp/agent-console.sock
```

### Terminal Initialization Pattern

```rust
use crossterm::{
    terminal::{enable_raw_mode, disable_raw_mode, EnterAlternateScreen, LeaveAlternateScreen},
    execute,
};
use ratatui::prelude::*;

pub fn setup_terminal() -> Result<Terminal<CrosstermBackend<Stdout>>> {
    enable_raw_mode()?;
    let mut stdout = std::io::stdout();
    execute!(stdout, EnterAlternateScreen)?;
    let backend = CrosstermBackend::new(stdout);
    Terminal::new(backend)
}

pub fn restore_terminal(terminal: &mut Terminal<CrosstermBackend<Stdout>>) -> Result<()> {
    disable_raw_mode()?;
    execute!(terminal.backend_mut(), LeaveAlternateScreen)?;
    terminal.show_cursor()?;
    Ok(())
}
```

### Event Loop Architecture

The event loop uses `tokio::select!` to multiplex three sources:

1. **Terminal input events** (keyboard, resize) via crossterm
2. **Daemon subscription updates** (sessions, usage) via socket (added in
   S004.02)
3. **UI refresh tick** (250ms default, configurable via `[ui] tick_rate`)

```rust
loop {
    tokio::select! {
        Some(event) = terminal_events.next() => {
            // Handle keyboard, resize events
        }
        Some(update) = daemon_updates.next() => {
            // Handle session/usage updates from daemon (S004.02)
        }
        _ = tick_interval.tick() => {
            // Trigger UI refresh
        }
    }
}
```

### Connection Behavior

- **Auto-reconnect:** If daemon disconnects, show "disconnected" in status area
  and auto-reconnect with exponential backoff (100ms → 5s max)
- **Terminal restoration:** Panic hook restores terminal on crash (crossterm
  cleanup)
- **Data source:** TUI receives ALL data from daemon (sessions + usage). No
  direct API calls. See [widget data flow](../architecture/widget-data-flow.md).
