# Story: Add Layout Presets

**Story ID:** S005.05 **Epic:**
[E005 - Widget System](../epic/E005-widget-system.md) **Status:** Draft
**Priority:** P1 **Estimated Points:** 5

## Description

As a user, I want to switch between predefined layout presets, So that I can
quickly adapt the dashboard to different use cases without manual configuration.

## Context

Layout presets are predefined collections of widgets that serve different use
cases. Users can switch between layouts instantly using keyboard shortcuts (`1`
for default, `2` for compact). This provides a balance between customization
flexibility and ease of use.

Two built-in layouts cover v0 scenarios: a default two-line session-status with
api-usage, and a compact one-line variant. Custom layout configuration and
additional presets are deferred to v2+.

## Implementation Details

### Technical Approach

1. Create `crates/agent-console-dashboard/src/layout/mod.rs` as layout module
   entry point
2. Create `crates/agent-console-dashboard/src/layout/presets.rs` with built-in
   layout definitions
3. Create `crates/agent-console-dashboard/src/layout/manager.rs` for layout
   switching logic
4. Define Layout struct holding ordered widget list
5. Implement keyboard shortcuts (`1` default, `2` compact) for layout switching

### Files to Modify

- `crates/agent-console-dashboard/src/layout/mod.rs` - Layout module entry point
- `crates/agent-console-dashboard/src/layout/presets.rs` - Built-in layout
  preset definitions
- `crates/agent-console-dashboard/src/layout/manager.rs` - Layout manager and
  switching logic
- `crates/agent-console-dashboard/src/tui/app.rs` - Integrate layout manager
  with TUI
- `crates/agent-console-dashboard/src/tui/event.rs` - Handle layout switching
  keyboard events
- `crates/agent-console-dashboard/src/main.rs` - Add --layout CLI flag

### Dependencies

- [S005.01 - Widget Trait/Interface](./S005.01-widget-trait-interface.md) -
  Widget trait for layout composition
- [S004.01 - Ratatui Application Scaffold](./S004.01-ratatui-application-scaffold.md)
  \- TUI foundation
- [S004.03 - Keyboard Navigation](./S004.03-keyboard-navigation.md) - Keyboard
  event handling

## Acceptance Criteria

- [ ] Given the TUI is running, when `1` is pressed, then default layout
      activates (session-status:two-line, api-usage)
- [ ] Given the TUI is running, when `2` is pressed, then compact layout
      activates (session-status:one-line, api-usage)
- [ ] Given the TUI is in the main dashboard view (not detail, help, or modal),
      when `1`-`2` is pressed, then layout switches; in all other views these
      keys are ignored or handled by the active view
- [ ] Given the layout changes, when rendered, then widgets update immediately
      without restart
- [ ] Given an invalid layout name is used, when TUI starts, then default layout
      is used with warning

## Testing Requirements

- [ ] Unit test: Built-in layouts contain expected widgets
- [ ] Unit test: Layout switching changes active widget set
- [ ] Unit test: Custom layout parsing from TOML works correctly
- [ ] Unit test: Invalid layout name falls back to default
- [ ] Integration test: Keyboard shortcuts switch layouts correctly
- [ ] Integration test: CLI --layout flag sets initial layout

## Out of Scope

- Layout editing at runtime (future enhancement)
- Per-session layouts
- Layout persistence after closing
- Animated layout transitions
- Widget reordering via keyboard

## Notes

### Built-in Layouts

| Layout    | Widgets                                | Use Case | Shortcut |
| --------- | -------------------------------------- | -------- | -------- |
| `default` | `session-status:two-line`, `api-usage` | Standard | `1`      |
| `compact` | `session-status:one-line`, `api-usage` | Minimal  | `2`      |

Custom layout configuration and additional presets are deferred to v2+.

### Layout Mockups

**Default Layout (1):**

```text
proj-a: ● | proj-b: 2m34s | proj-c: ?
Quota: 5h 8% | 7d 77% | resets 2h 15m
```

**Compact Layout (2):**

```text
proj-a: ● | proj-b: 2m34s | proj-c: ?  Quota: 5h 8% | 7d 77%
```

### Implementation

```rust
use crate::widgets::Widget;
use std::collections::HashMap;

pub struct Layout {
    name: String,
    widgets: Vec<Box<dyn Widget>>,
}

impl Layout {
    pub fn widgets(&self) -> &[Box<dyn Widget>] {
        &self.widgets
    }
}

pub struct LayoutManager {
    layouts: HashMap<String, Layout>,
    active: String,
}

impl LayoutManager {
    pub fn new() -> Self {
        let mut manager = Self {
            layouts: HashMap::new(),
            active: "one-line".to_string(),
        };

        // Register built-in layouts (v0: 2 presets only)
        manager.register_preset("default", vec!["session-status:two-line", "api-usage"]);
        manager.register_preset("compact", vec!["session-status:one-line", "api-usage"]);

        manager
    }

    pub fn switch_to(&mut self, name: &str) -> bool {
        if self.layouts.contains_key(name) {
            self.active = name.to_string();
            true
        } else {
            false
        }
    }

    pub fn switch_by_index(&mut self, index: usize) -> bool {
        match index {
            1 => self.switch_to("default"),
            2 => self.switch_to("compact"),
            _ => false,
        }
    }

    pub fn active_layout(&self) -> Option<&Layout> {
        self.layouts.get(&self.active)
    }

    fn register_preset(&mut self, name: &str, widget_ids: Vec<&str>) {
        let registry = WidgetRegistry::new();
        let widgets: Vec<_> = widget_ids
            .iter()
            .filter_map(|id| registry.create(id))
            .collect();

        self.layouts.insert(name.to_string(), Layout {
            name: name.to_string(),
            widgets,
        });
    }
}
```

### Configuration (TOML)

```toml
[tui.layout]
preset = "default"  # default | compact

[tui.layout.presets.default]
widgets = ["session-status:two-line", "api-usage"]

[tui.layout.presets.compact]
widgets = ["session-status:one-line", "api-usage"]
```

Custom layout configuration and additional presets are deferred to v2+.

### Keyboard Event Handling

```rust
fn handle_layout_key(app: &mut App, key: KeyEvent) -> bool {
    match key.code {
        KeyCode::Char('1') => app.layout_manager.switch_by_index(1), // default
        KeyCode::Char('2') => app.layout_manager.switch_by_index(2), // compact
        _ => false,
    }
}
```

### Project Structure

```text
src/
├── layout/
│   ├── mod.rs           # Layout module entry
│   ├── presets.rs       # Built-in layout definitions
│   └── manager.rs       # Layout switching logic
```
