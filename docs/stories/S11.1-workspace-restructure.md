# Story: Restructure as Cargo Workspace

**Story ID:** S11.1 **Epic:**
[E011 - Claude Usage Crate](../epic/E011-claude-usage-crate.md) **Status:**
Draft **Priority:** P0 **Estimated Points:** 2

## Description

As a developer, I want to restructure the project as a Cargo workspace, So that
we can have multiple crates (binary and library) in a single repository.

## Context

The project currently has a single crate structure. To add the `claude-usage`
library crate alongside the existing binary, we need to convert to a Cargo
workspace. This is a foundational change that must happen before adding the new
crate.

## Implementation Details

### Technical Approach

1. Create `crates/` directory
2. Move existing source code to `crates/agent-console-dashboard/`
3. Create `crates/claude-usage/` with minimal lib.rs
4. Update root `Cargo.toml` to be workspace manifest
5. Create individual `Cargo.toml` for each crate
6. Update any relative paths in existing code
7. Verify all tests still pass

### New Structure

```text
agent-console-dashboard/
├── Cargo.toml                    # workspace manifest
├── crates/
│   ├── agent-console-dashboard/
│   │   ├── Cargo.toml
│   │   └── src/
│   │       ├── main.rs
│   │       └── ...
│   └── claude-usage/
│       ├── Cargo.toml
│       └── src/
│           └── lib.rs
├── docs/
├── tests/                        # workspace-level integration tests
└── ...
```

### Files to Modify

- `Cargo.toml` - Convert to workspace manifest
- `crates/agent-console-dashboard/Cargo.toml` - New (binary crate manifest)
- `crates/claude-usage/Cargo.toml` - New (library crate manifest)
- `crates/claude-usage/src/lib.rs` - New (minimal placeholder)

### Dependencies

- None (first story in epic)

## Acceptance Criteria

- [ ] Given the restructured workspace, when `cargo build` runs, then both
      crates compile successfully
- [ ] Given the restructured workspace, when `cargo test` runs, then all
      existing tests pass
- [ ] Given the binary crate, when built, then `acd` binary is produced
- [ ] Given the library crate, when built, then `claude-usage` library compiles
- [ ] Given the workspace, when `cargo check --workspace` runs, then no errors

## Testing Requirements

- [ ] Existing unit tests pass after restructure
- [ ] Existing integration tests pass after restructure
- [ ] `cargo build --workspace` succeeds
- [ ] `cargo test --workspace` succeeds

## Out of Scope

- Implementing claude-usage functionality (separate stories)
- Updating CI/CD (can be done incrementally)

## Notes

### Workspace Cargo.toml

```toml
[workspace]
members = ["crates/agent-console-dashboard", "crates/claude-usage"]
resolver = "2"
```

### Binary Crate Cargo.toml

```toml
[package]
name = "agent-console-dashboard"
version = "0.1.0"
edition = "2021"

[[bin]]
name = "acd"
path = "src/main.rs"

[dependencies]
# ... existing dependencies ...
```

### Library Crate Cargo.toml (Minimal)

```toml
[package]
name = "claude-usage"
version = "0.1.0"
edition = "2021"
description = "Fetch Claude API usage data from Anthropic"
license = "MIT OR Apache-2.0"
repository = "https://github.com/PabloLION/agent-console-dashboard"
keywords = ["claude", "anthropic", "usage", "api"]
categories = ["api-bindings"]

[dependencies]
# To be added in subsequent stories
```

### Migration Steps

1. `mkdir -p crates/agent-console-dashboard crates/claude-usage`
2. `git mv src crates/agent-console-dashboard/`
3. `git mv tests crates/agent-console-dashboard/` (if crate-specific)
4. Create new Cargo.toml files
5. `cargo build --workspace` to verify
