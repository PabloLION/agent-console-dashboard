# Story: Implement Session Selection and Detail View

**Story ID:** S4.4 **Epic:**
[E004 - TUI Dashboard](../epic/E004-tui-dashboard.md) **Status:** Draft
**Priority:** P2 **Estimated Points:** 5

## Description

As a user, I want to expand a selected session to see detailed information, So
that I can view session history, API usage, and perform session-specific
actions.

## Context

The session detail view provides an expanded look at a single session when the
user presses Enter on a selected session. This view displays comprehensive
information including session status, working directory, session ID, API usage,
and state transition history. It also provides contextual actions like Resurrect
and Close.

This is a modal view that overlays the main dashboard and can be dismissed with
Escape.

## Implementation Details

### Technical Approach

1. Create `detail.rs` view component
2. Implement modal overlay rendering on top of dashboard
3. Display session metadata (status, working dir, session ID)
4. Show API usage summary if available
5. Render state history timeline (recent transitions)
6. Add action buttons/shortcuts (Resurrect, Close)
7. Handle Escape to close and return to dashboard
8. Support scrolling if history exceeds view height

### Files to Modify

- `src/tui/views/mod.rs` - Add detail view export
- `src/tui/views/detail.rs` - Session detail view component
- `src/tui/app.rs` - Add view state (Dashboard/Detail), transition logic
- `src/tui/ui.rs` - Render detail view when active
- `src/tui/event.rs` - Handle detail view keyboard events

### Dependencies

- [S4.1 - Ratatui Application Scaffold](./S4.1-ratatui-application-scaffold.md) -
  TUI foundation
- [S4.2 - Main Dashboard Layout](./S4.2-main-dashboard-layout.md) - Main view to
  overlay
- [S4.3 - Keyboard Navigation](./S4.3-keyboard-navigation.md) - Enter key
  triggers detail
- [S2.3 - Session State History](./S2.3-session-state-history.md) - History data
  model

## Acceptance Criteria

- [ ] Given a session is selected, when Enter is pressed, then detail view opens
      as modal overlay
- [ ] Given detail view is open, when rendered, then session status with color
      indicator is shown
- [ ] Given detail view is open, when rendered, then working directory path is
      displayed
- [ ] Given detail view is open, when rendered, then session ID (truncated with
      ellipsis) is shown
- [ ] Given detail view is open, when rendered, then API usage summary is
      displayed (if available)
- [ ] Given detail view is open, when rendered, then state history timeline
      shows recent transitions
- [ ] Given detail view is open, when Escape is pressed, then view closes and
      returns to dashboard
- [ ] Given detail view for closed session, when `r` is pressed, then resurrect
      action is triggered
- [ ] Given detail view, when `c` is pressed, then close/remove session action
      is triggered
- [ ] Given history exceeds view height, when scrolling keys used, then history
      scrolls

## Testing Requirements

- [ ] Unit test: Detail view renders all required fields
- [ ] Unit test: History timeline formats timestamps correctly
- [ ] Unit test: Escape key triggers close action
- [ ] Integration test: Enter opens detail, Escape closes it
- [ ] Integration test: Actions from detail view execute correctly

## Out of Scope

- Editing session properties (future enhancement)
- Live-following session logs (future enhancement)
- Session comparison view (future enhancement)
- Full API usage breakdown (E009)

## Notes

### Detail View Layout

```text
┌── proj-b ──────────────────────────────────┐
│ Status: Attention (2m34s)                  │
│ Working Dir: ~/projects/proj-b             │
│ Session ID: abc123...                      │
│ API Usage: 5.2k tokens                     │
│                                            │
│ History:                                   │
│   14:32:01  Working → Attention            │
│   14:30:45  Attention → Working            │
│   14:28:12  Working → Attention            │
│                                            │
│ [R]esurrect  [C]lose  [ESC] Back           │
└────────────────────────────────────────────┘
```

### View State Machine

```rust
pub enum View {
    Dashboard,
    Detail { session_index: usize },
    Help,
}

pub struct App {
    view: View,
    sessions: Vec<Session>,
    // ...
}

impl App {
    pub fn open_detail(&mut self) {
        if !self.sessions.is_empty() {
            self.view = View::Detail {
                session_index: self.selected_index
            };
        }
    }

    pub fn close_detail(&mut self) {
        self.view = View::Dashboard;
    }
}
```

### Detail View Key Handling

```rust
fn handle_detail_key(app: &mut App, key: KeyEvent, session_index: usize) -> Action {
    match key.code {
        KeyCode::Esc => {
            app.close_detail();
            Action::None
        }
        KeyCode::Char('r') | KeyCode::Char('R') => {
            if let Some(session) = app.sessions.get(session_index) {
                Action::Resurrect(session.id.clone())
            } else {
                Action::None
            }
        }
        KeyCode::Char('c') | KeyCode::Char('C') => {
            if let Some(session) = app.sessions.get(session_index) {
                Action::CloseSession(session.id.clone())
            } else {
                Action::None
            }
        }
        KeyCode::Char('j') | KeyCode::Down => Action::ScrollHistoryDown,
        KeyCode::Char('k') | KeyCode::Up => Action::ScrollHistoryUp,
        _ => Action::None,
    }
}
```

### Rendering as Modal Overlay

```rust
fn render_detail_view(frame: &mut Frame, session: &Session, area: Rect) {
    // Calculate centered modal area
    let modal_width = 50.min(area.width.saturating_sub(4));
    let modal_height = 15.min(area.height.saturating_sub(2));
    let x = (area.width - modal_width) / 2;
    let y = (area.height - modal_height) / 2;
    let modal_area = Rect::new(x, y, modal_width, modal_height);

    // Clear the modal area background
    frame.render_widget(Clear, modal_area);

    // Render the detail content
    let block = Block::default()
        .title(format!("── {} ──", session.name))
        .borders(Borders::ALL)
        .border_style(Style::default().fg(Color::Cyan));

    frame.render_widget(block, modal_area);

    // Render content inside block
    let inner = block.inner(modal_area);
    render_detail_content(frame, session, inner);
}
```

### History Timeline Format

Each history entry shows:

- Timestamp (HH:MM:SS format)
- Transition (Previous State → New State)

```text
History:
  14:32:01  Working → Attention
  14:30:45  Attention → Working
  14:28:12  Idle → Working
```

Timestamps are displayed in local time. If many entries exist, show most recent
N entries with scroll indicator.

### Action Feedback

When an action is triggered from detail view:

1. Show brief "Action sent..." feedback
2. Wait for daemon confirmation
3. Update session state if successful
4. Show error message if failed

Consider using a status line at bottom of detail view for feedback.
