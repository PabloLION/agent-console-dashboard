# Story: Create Stop Hook Script

**Story ID:** S006.01 **Epic:**
[E006 - Claude Code Integration](../epic/E006-claude-code-integration.md)
**Status:** Draft **Priority:** P1 **Estimated Points:** 2

## Description

As a user, I want a hook script that runs when Claude Code stops or completes,
So that my dashboard automatically shows which sessions need attention.

## Context

The Stop hook is fired by Claude Code whenever a session stops or completes its
work. This is a critical integration point because it signals that Claude has
finished processing and may be waiting for user input or has completed the task.
The dashboard should immediately reflect this state change by setting the
session status to "Attention".

Claude Code passes JSON data via stdin to ALL hook types, including the
`session_id` field which uniquely identifies the session. Hooks must parse this
JSON to extract `session_id` (not derive it from `basename $PWD`). See
[discussion decision D8](../architecture/2026-01-31-discussion-decisions.md).

## Implementation Details

### Technical Approach

1. Create `scripts/hooks/stop.sh` (template for users to copy)
2. Script reads JSON from stdin using `cat` and `jq`
3. Script extracts `session_id` field from JSON
4. Script calls `agent-console set <session_id> attention` to update status
5. Script must be executable and use `/bin/bash` shebang
6. Include comments explaining usage and customization options

### Files to Modify

- `scripts/hooks/stop.sh` - Create the stop hook script template
- `scripts/hooks/README.md` - Document hook installation (if not exists)

### Dependencies

- [E001 - Daemon Core Infrastructure](../epic/E001-daemon-core-infrastructure.md) -
  Daemon must be running
- [S003.02 - SET Command](./S003.02-set-command.md) - CLI SET command must work
- [S003.05 - CLI Client Commands](./S003.05-cli-client-commands.md) -
  agent-console CLI must be installed

## Acceptance Criteria

- [ ] Given the stop.sh script exists, when copied to `~/.claude/hooks/`, then
      it is ready to use
- [ ] Given Claude Code invokes the stop hook with JSON stdin, when the script
      runs, then `session_id` is extracted from JSON
- [ ] Given `session_id` is extracted, when script runs, then
      `agent-console set <session_id> attention` is called
- [ ] Given the agent-console daemon is not running, when hook is invoked, then
      script fails gracefully (no crash)
- [ ] Given the script is examined, when read by a user, then comments explain
      how to customize and install it
- [ ] Given the script runs, when completed, then it exits with status 0 on
      success
- [ ] Given JSON stdin has required fields, when parsed, then script correctly
      extracts session_id

## Testing Requirements

- [ ] Manual test: Copy script to `~/.claude/hooks/stop.sh` and verify it
      executes
- [ ] Manual test: Provide sample JSON stdin and verify session_id extraction
- [ ] Manual test: Run script when daemon is not running to verify graceful
      failure
- [ ] Unit test: Script extracts correct session_id from various JSON samples

## Out of Scope

- Automatic installation of hook scripts (user copies manually)
- Integration with AskUserQuestion hook (detectable via PreToolUse since
  v2.0.76; separate story if needed)
- Custom status beyond "attention"
- Windows support (bash scripts only)

## Notes

### Script Template

```bash
#!/bin/bash
# Agent Console Dashboard - Stop Hook for Claude Code
#
# This script is invoked when a Claude Code session stops or completes.
# It sets the session status to "Attention" in the dashboard.
#
# Installation:
#   1. Copy this file to ~/.claude/hooks/stop.sh
#   2. Make it executable: chmod +x ~/.claude/hooks/stop.sh
#   3. Register in ~/.claude/settings.json (see S006.04)
#
# Customization:
#   - Add logging by appending to a log file
#   - Add notifications (e.g., terminal-notifier, notify-send)

# Read JSON stdin and extract session_id
INPUT=$(cat)
SESSION_ID=$(echo "$INPUT" | jq -r '.session_id')

# Update dashboard status
agent-console set "$SESSION_ID" attention
```

### JSON Stdin Format

Claude Code passes JSON to ALL hook types via stdin. Example for Stop hook:

```json
{
  "session_id": "abc123-def456-ghi789",
  "cwd": "/home/user/projects/my-app",
  "transcript_path": "/home/user/.claude/transcripts/abc123.md",
  "permission_mode": "ask",
  "hook_event_name": "Stop"
}
```

The script extracts `session_id` directly. No need for `basename $PWD` pattern.

### Session Identification

**Decision D8:** Claude Code exposes `session_id` in JSON stdin to ALL hook
types. This is the primary session identifier.

Hooks MUST parse stdin JSON to extract `session_id`. The `basename "$PWD"`
pattern in older documentation is stale and incorrect.

### Error Handling

The script should not prevent Claude Code from operating if it fails. Consider:

- Using `|| true` to suppress error exit codes
- Logging errors to a file for debugging
- Timeout on agent-console call (in case daemon hangs)

### Future Enhancements

- Support for custom status via environment variable
- Support for multiple dashboard instances
- Integration with system notifications
