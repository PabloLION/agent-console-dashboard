# Story: Create Notification Hook Script

**Story ID:** S006.03 **Epic:**
[E006 - Claude Code Integration](../epic/E006-claude-code-integration.md)
**Status:** Draft **Priority:** P1 **Estimated Points:** 2

## Description

As a user, I want a hook script that runs when Claude Code sends a notification,
So that my dashboard alerts me when Claude needs my attention mid-conversation.

## Context

The Notification hook is fired by Claude Code when it wants to notify the user
about something important. This could be a question, a request for
clarification, an error that needs attention, or a milestone completion. Unlike
the Stop hook (which fires when processing ends), the Notification hook can fire
mid-conversation.

Claude Code passes JSON data via stdin to ALL hook types, including the
`session_id` field which uniquely identifies the session. Hooks must parse this
JSON to extract `session_id` (not derive it from `basename $PWD`). See
[discussion decision D8](../architecture/2026-01-31-discussion-decisions.md).

The dashboard should set the session status to "Attention" when a notification
occurs, signaling that the user should check on this session. This enables
efficient multi-tasking across multiple Claude Code sessions.

## Implementation Details

### Technical Approach

1. Create `scripts/hooks/notification.sh` (template for users to copy)
2. Script reads JSON from stdin using `cat` and `jq`
3. Script extracts `session_id` field from JSON
4. Script calls `agent-console set <session_id> attention` to update status
5. Script must be executable and use `/bin/bash` shebang
6. Include comments explaining usage and customization options
7. Optionally trigger system notifications (commented out by default)

### Files to Modify

- `scripts/hooks/notification.sh` - Create the notification hook script template
- `scripts/hooks/README.md` - Update hook documentation (if exists)

### Dependencies

- [E001 - Daemon Core Infrastructure](../epic/E001-daemon-core-infrastructure.md) -
  Daemon must be running
- [S003.02 - SET Command](./S003.02-set-command.md) - CLI SET command must work
- [S003.05 - CLI Client Commands](./S003.05-cli-client-commands.md) -
  agent-console CLI must be installed
- [S006.01 - Stop Hook Script](./S006.01-stop-hook-script.md) - Follows same
  pattern

## Acceptance Criteria

- [ ] Given the notification.sh script exists, when copied to
      `~/.claude/hooks/`, then it is ready to use
- [ ] Given Claude Code sends a notification with JSON stdin, when the hook
      runs, then `session_id` is extracted from JSON
- [ ] Given `session_id` is extracted, when script runs, then
      `agent-console set <session_id> attention` is called
- [ ] Given the agent-console daemon is not running, when hook is invoked, then
      script fails gracefully (no crash)
- [ ] Given a session was in "Working" status, when notification fires, then
      status changes to "Attention"
- [ ] Given the script includes optional system notification code, when user
      enables it, then OS notifications appear

## Testing Requirements

- [ ] Manual test: Copy script to `~/.claude/hooks/notification.sh` and verify
      it executes
- [ ] Manual test: Provide sample JSON stdin and verify session_id extraction
- [ ] Manual test: Trigger a notification in Claude Code and verify dashboard
      updates
- [ ] Manual test: Verify status transition from Working to Attention in
      dashboard
- [ ] Manual test: Run script when daemon is not running to verify graceful
      failure
- [ ] Manual test: Enable and test system notification integration (macOS/Linux)

## Out of Scope

- Capturing notification content or message (available in JSON but not used)
- Different status types based on notification type
- Notification history tracking
- Windows support (bash scripts only)

## Notes

### Script Template

```bash
#!/bin/bash
# Agent Console Dashboard - Notification Hook for Claude Code
#
# This script is invoked when Claude Code sends a notification.
# It sets the session status to "Attention" in the dashboard.
#
# Installation:
#   1. Copy this file to ~/.claude/hooks/notification.sh
#   2. Make it executable: chmod +x ~/.claude/hooks/notification.sh
#   3. Register in ~/.claude/settings.json (see S006.04)
#
# Customization:
#   - Uncomment system notification lines below for OS-level alerts

# Read JSON stdin and extract session_id
INPUT=$(cat)
SESSION_ID=$(echo "$INPUT" | jq -r '.session_id')

# Update dashboard status
agent-console set "$SESSION_ID" attention

# Optional: System notification (uncomment one based on your OS)
#
# macOS:
# osascript -e "display notification \"Claude needs attention\" with title \"Session $SESSION_ID\""
#
# Linux (requires notify-send):
# notify-send "Agent Console" "Claude needs attention in session $SESSION_ID"
```

### JSON Stdin Format

Claude Code passes JSON to ALL hook types via stdin. Example for Notification:

```json
{
  "session_id": "abc123-def456-ghi789",
  "cwd": "/home/user/code/frontend",
  "transcript_path": "/home/user/.claude/transcripts/abc123.md",
  "permission_mode": "ask",
  "hook_event_name": "Notification",
  "message": "Should I proceed with the migration?"
}
```

The script extracts `session_id` directly from JSON.

### Notification Types

Claude Code may send notifications for various reasons:

| Reason     | Example                                |
| ---------- | -------------------------------------- |
| Question   | "Should I proceed with the migration?" |
| Error      | "Build failed with error X"            |
| Permission | "Can I modify file Y?"                 |
| Completion | "Task completed successfully"          |

Currently, all notification types result in the same "Attention" status. Future
versions could differentiate:

- Question → "Question" status (blue `?`)
- Error → "Error" status (red `!`)
- Completion → Keep "Attention" (yellow time)

### System Notification Integration

The script template includes commented-out examples for system notifications:

**macOS:**

```bash
osascript -e "display notification \"Claude needs attention\" with title \"Session $SESSION_ID\""
```

**Linux (GNOME/KDE):**

```bash
notify-send "Agent Console" "Claude needs attention in session $SESSION_ID"
```

Users can enable these for additional visibility when working with multiple
terminals or applications.

### Difference from Stop Hook

| Hook         | When Fired       | Typical Scenario               |
| ------------ | ---------------- | ------------------------------ |
| Stop         | Session ends     | Claude finished all work       |
| Notification | Mid-conversation | Claude has a question or alert |

Both hooks set status to "Attention", but they fire at different times. The
Notification hook is more immediate - it signals that Claude is still in the
conversation but needs user input.

### AskUserQuestion Hook Note

Claude Code's AskUserQuestion tool is detectable via the PreToolUse hook since
v2.0.76. A separate story could add a "Question" status when AskUserQuestion is
detected, distinct from the generic "Attention" status set by the Notification
hook.

### Session Identification

**Decision D8:** Claude Code exposes `session_id` in JSON stdin to ALL hook
types. This is the primary session identifier.

Hooks MUST parse stdin JSON to extract `session_id`. The `basename "$PWD"`
pattern in older documentation is stale and incorrect.
