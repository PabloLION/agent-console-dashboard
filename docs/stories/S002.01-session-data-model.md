# Story: Define Session Data Model

**Story ID:** S002.01 **Epic:**
[E002 - Session Management](../epic/E002-session-management.md) **Status:**
Draft **Priority:** P1 **Estimated Points:** 3

## Description

As a developer, I want to define a comprehensive session data model, So that I
can represent all necessary session information for tracking and displaying
agent sessions.

## Context

The session data model is the foundation of the Agent Console Dashboard's
session management capabilities. It captures all information required to track,
display, and resurrect agent sessions. The model supports multiple agent types
(starting with Claude Code) and maintains enough state for real-time monitoring.

This story builds on S001.03 (in-memory session store) by defining the domain
types that the store will manage.

Key design decisions from architecture:

- State is ephemeral (not persisted across reboots) per
  [E002](../epic/E002-session-management.md)
- Model supports future agent types via AgentType enum
- Sessions identified by `session_id` from Claude Code's JSON stdin per
  [D8](../architecture/2026-01-31-discussion-decisions.md)
- API usage is handled separately at account level (E011), not per-session per
  [D3](../architecture/2026-01-31-discussion-decisions.md)

## Implementation Details

### Technical Approach

1. Define the core `Session` struct with all required fields
2. Define the `Status` enum with all possible states (Working, Attention,
   Question, Closed)
3. Define the `AgentType` enum for extensibility
4. Define the `StateTransition` struct for history tracking
5. Implement `Default` traits where appropriate
6. Implement serialization with serde for JSON output

### Files to Create/Modify

- `crates/agent-console-dashboard/src/daemon/session.rs` (new) - Session data
  model types
- `crates/agent-console-dashboard/src/daemon/mod.rs` - Re-export session types
- `crates/agent-console-dashboard/src/lib.rs` - Shared types if needed for
  client

### Dependencies

- [S001.03 - In-Memory Session Store](./S001.03-in-memory-session-store.md) -
  Store must exist before defining what it stores

## Acceptance Criteria

- [ ] Given the Session struct, then it contains: id, agent_type, status,
      working_dir, display_name, since, history, closed
- [ ] Given the Status enum, then it contains: Working, Attention, Closed
      variants
- [ ] Given the AgentType enum, then it contains: ClaudeCode variant with
      extensibility comment for future agents
- [ ] Given the StateTransition struct, then it contains: timestamp, from, to,
      duration fields
- [ ] Given the Session struct, then it does NOT contain per-session API usage
      fields (account-level usage is fetched by daemon via claude-usage crate)
- [ ] Given a Session instance, then it can be serialized to JSON for IPC
      responses
- [ ] Given a new session, then default values are sensible (empty history,
      closed=false)
- [ ] Given a `"/"` working_dir path, when display_name is derived, then it
      yields `"unknown"`
- [ ] Given a non-UTF8 working_dir path, when display_name is derived, then it
      yields `"unknown"`
- [ ] Given an empty string working_dir, when display_name is derived, then it
      yields `"unknown"`

## Testing Requirements

- [ ] Unit test: Session can be created with all required fields
- [ ] Unit test: Session serializes to valid JSON
- [ ] Unit test: Session deserializes from valid JSON
- [ ] Unit test: Status enum serializes as expected strings ("working",
      "attention", etc.)
- [ ] Unit test: Default implementations produce expected values

## Out of Scope

- Status transition validation logic (S002.02)
- State history recording logic (S002.03)
- Lifecycle event handling (S002.04)
- API usage update logic (E011)

## Notes

### Data Model Reference

```rust
/// Session state with history
struct Session {
    id: String,              // From session_id in Claude Code JSON stdin
    agent_type: AgentType,   // ClaudeCode, Future agents
    status: Status,
    working_dir: PathBuf,    // From cwd in JSON stdin
    display_name: String,    // Derived from basename of cwd
    since: Instant,          // When status last changed
    history: Vec<StateTransition>,
    closed: bool,            // For resurrection feature
}

enum Status {
    Working,
    Attention,
    Question,
    Closed,
}

enum AgentType {
    ClaudeCode,
    // Future: Other agents
}

struct StateTransition {
    timestamp: Instant,
    from: Status,
    to: Status,
    duration: Duration,
}

// Note: Per-session API usage is NOT stored in Session.
// Account-level quota is fetched by daemon via claude_usage::get_usage() (E011)
// and broadcast to all TUIs. See D3 (Widget Data Flow).
```

### Session Identification

Per [D8](../architecture/2026-01-31-discussion-decisions.md):

Sessions are identified by `session_id` from Claude Code's JSON stdin, available
in ALL hook types (Stop, UserPromptSubmit, Notification, PreToolUse,
SessionStart, SessionEnd).

Hook scripts extract session_id from stdin:

```bash
INPUT=$(cat)
SESSION_ID=$(echo "$INPUT" | jq -r '.session_id')
agent-console set "$SESSION_ID" working
```

Available fields in hook JSON stdin: `session_id`, `cwd`, `transcript_path`,
`permission_mode`, `hook_event_name` (plus event-specific fields).

**Session auto-creation:** First SET for an unknown session_id creates the
session automatically. No explicit registration step needed.

### Display Name Derivation

The `display_name` field is derived from the `working_dir`:

```rust
impl Session {
    fn new(id: String, working_dir: PathBuf) -> Self {
        let display_name = working_dir
            .file_name()
            .and_then(|n| n.to_str())
            .unwrap_or("unknown")
            .to_string();

        Self {
            id,
            display_name,
            working_dir,
            // ... other fields
        }
    }
}
```

### Serialization Considerations

- `Instant` and `Duration` need custom serialization (convert to Unix
  timestamps/milliseconds for JSON)
- `PathBuf` serializes as string path
- Status enum should serialize as lowercase strings for IPC protocol consistency
  ("working", "attention", "closed")

### Key Dependencies

| Crate      | Purpose                     |
| ---------- | --------------------------- |
| serde      | Serialization derive macros |
| serde_json | JSON serialization          |

### Hook JSON stdin Example

Claude Code sends the following JSON to hook scripts via stdin:

```json
{ "session_id": "abc123", "cwd": "/Users/foo/project", "session_type": "task" }
```

The `cwd` field from this JSON maps to the internal `working_dir` field in the
Session struct.

### Session ID Format

Session IDs are opaque strings provided by Claude Code via hook JSON stdin. The
daemon performs no format validation — it treats session IDs as opaque
identifiers. Any non-empty string is accepted.

### Display Name Edge Cases

The `display_name` derivation handles edge cases:

- `"/"` path yields `"unknown"`
- Non-UTF8 paths yield `"unknown"`
- Empty string yields `"unknown"`

### Timestamp Representation

Internal representation uses `Instant` for elapsed calculations. When serialized
to JSON (e.g., STATE/UPDATE responses), timestamps are converted to Unix seconds
(u64).

### Metadata Persistence Note

Per [E002](../epic/E002-session-management.md):

Session state is in-memory only, lost on daemon restart. This is intentional —
sessions are volatile and re-register via hooks. Closed sessions retain metadata
for potential resurrection (E008), but this is also ephemeral.
