# Story: Implement Session Status Transitions

**Story ID:** S002.02 **Epic:**
[E002 - Session Management](../epic/E002-session-management.md) **Status:**
Draft **Priority:** P1 **Estimated Points:** 3

## Description

As a developer, I want to implement validated session status transitions, So
that sessions can only move between valid states and invalid transitions are
rejected.

## Context

Session status transitions represent the core business logic of the session
management system. Each status change must be validated to ensure data integrity
and prevent invalid states. The transition logic also updates the `since`
timestamp and triggers history recording.

Status states and their triggers per [E002](../epic/E002-session-management.md):

| Status    | Meaning                         | Triggered By                                       |
| --------- | ------------------------------- | -------------------------------------------------- |
| Working   | Agent is processing             | UserPromptSubmit hook                              |
| Attention | Agent stopped, waiting for user | Stop hook, Notification hook, AskUserQuestion hook |
| Closed    | Session ended                   | SessionEnd hook                                    |

## Implementation Details

### Technical Approach

1. Define valid transition rules as a state machine
2. Implement `Session::set_status()` method with validation
3. Return error for invalid transitions (primarily Closed → anything except via
   RESURRECT)
4. Update `since` field on successful transition
5. Calculate duration in previous state
6. Trigger history recording (calls into S002.03 implementation)
7. Handle same-status transitions (update timestamp, no history entry)

### Files to Modify

- `crates/agent-console-dashboard/src/daemon/session.rs` - Add transition
  methods to Session
- `crates/agent-console-dashboard/src/daemon/store.rs` - Add store method for
  status updates

### Dependencies

- [S002.01 - Session Data Model](./S002.01-session-data-model.md) - Data model
  must be defined first

## Acceptance Criteria

- [ ] Given a session in Working status, when transitioning to Attention, then
      the transition succeeds
- [ ] Given a session in Working status, when transitioning to Attention via
      AskUserQuestion, then the transition succeeds
- [ ] Given a session in any status, when transitioning to Closed, then the
      transition succeeds
- [ ] Given a session in Closed status, when transitioning to any other status
      (except via RESURRECT command), then the transition is rejected
- [ ] Given any status transition, when it succeeds, then the `since` field is
      updated to current time
- [ ] Given any status transition, when it succeeds, then the duration in
      previous state is calculated
- [ ] Given any status transition, when it succeeds, then history recording is
      triggered
- [ ] Given a transition to the same status (e.g., Working → Working), then it
      updates the `since` timestamp but does not record a new history entry

## Testing Requirements

- [ ] Unit test: All valid transitions succeed
- [ ] Unit test: Invalid transitions (from Closed without resurrection) are
      rejected
- [ ] Unit test: `since` timestamp updates on transition
- [ ] Unit test: Duration calculation is accurate
- [ ] Unit test: Same-status transitions handled correctly
- [ ] Integration test: Transition triggers history recording

## Out of Scope

- State history storage implementation (S002.03)
- Lifecycle event emission (S002.04)
- Hook integration (E006)
- IPC command handling (E003)

## Notes

### Valid Transition Matrix

Per [E002](../epic/E002-session-management.md):

| From      | To        | Valid? | Trigger                                            |
| --------- | --------- | ------ | -------------------------------------------------- |
| Working   | Attention | Yes    | Stop hook, Notification hook, AskUserQuestion hook |
| Working   | Closed    | Yes    | SessionEnd hook                                    |
| Attention | Working   | Yes    | UserPromptSubmit hook                              |
| Attention | Closed    | Yes    | SessionEnd hook                                    |
| Closed    | Working   | Yes    | Resurrection only (RESURRECT command)              |
| Closed    | \*        | No     | Cannot transition except resurrection              |

Same-status transitions (e.g., Working → Working) update `since` timestamp but
do not record a new history entry.

### Design Decision - Permissive Transitions

Use a **permissive** approach: allow any non-Closed transition, trust hooks to
send valid states. The only strict validation is preventing transitions from
Closed status without explicit resurrection.

Rationale: Hooks are the source of truth. Add stricter validation later if
issues arise in practice.

### Timestamp Handling

```rust
impl Session {
    fn set_status(&mut self, new_status: Status) -> Result<Duration, TransitionError> {
        // Prevent resurrection via normal SET
        if self.closed && new_status != Status::Closed {
            return Err(TransitionError::SessionClosed);
        }

        let now = Instant::now();
        let duration = now.duration_since(self.since);
        let old_status = std::mem::replace(&mut self.status, new_status);

        // Only update since timestamp if status actually changed
        if old_status != new_status {
            self.since = now;
            // Record history (S002.03)
            self.record_transition(old_status, new_status, duration);
        } else {
            // Same-status transition: update since but no history
            self.since = now;
        }

        Ok(duration)
    }
}
```

> **Note:** AskUserQuestion hook behavior is unverified -- tracked in beads
> issue acd-g5h.

### Notification Hook → Attention Mapping

The Notification hook fires when Claude Code produces output requiring user
attention (e.g., asking a question, showing an error). This maps to the
"attention" status because the session needs user interaction.

### Concurrency Note

With the **single-threaded actor model**, transitions are processed
sequentially. No race conditions on status updates. See
[concurrency model](../architecture/concurrency.md).
