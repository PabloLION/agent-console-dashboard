# Story: Update E009 to Use claude-usage

**Story ID:** S011.08 **Epic:**
[E011 - Claude Usage Crate](../epic/E011-claude-usage-crate.md) **Status:** Done
**Priority:** P2 **Estimated Points:** 2

## Description

As a maintainer, I want to update E009 documentation to reference the
claude-usage crate, So that there is no duplication of credential handling and
API logic between documentation.

## Context

After E011 is implemented, the claude-usage crate provides credential fetching
and API client functionality. E009 (API Usage Tracking) should consume this
crate rather than implementing its own credential/API logic. This story updates
the E009 epic and related stories to reflect this dependency.

## Implementation Details

### Technical Approach

1. Review E009 epic and stories (S009.01, S009.02, S009.03) for overlap with
   E011
2. Update E009 to depend on E011
3. Remove duplicated credential/API documentation from E009 stories
4. Update code examples to use `claude_usage::get_usage()`
5. Ensure clear separation: E011 = fetch data, E009 = track and display

### Files to Modify

- `docs/epic/E009-api-usage-tracking.md` - Add E011 dependency, update scope
- `docs/stories/S009.01-api-usage-data-model.md` - Reference claude-usage types
- `docs/stories/S009.02-api-usage-command.md` - Use claude-usage for data fetch
- `docs/stories/S009.03-api-usage-tui-display.md` - Minor updates if needed
- `docs/plans/6-open-questions.md` - Update Q34 to reference E011 completion

### Dependencies

- [S011.06 - Publish to crates.io](./S011.06-publish-crates-io.md) - Crate must
  be published and usable

## Acceptance Criteria

- [ ] Given E009 epic, when reviewed, then E011 is listed as dependency
- [ ] Given E009 stories, when reviewed, then no credential logic is duplicated
- [ ] Given code examples in E009, when reviewed, then they use `claude_usage`
      crate
- [ ] Given Q34 in open-questions, when reviewed, then it references E011
      implementation

## Testing Requirements

- [ ] Documentation review: No duplicate logic
- [ ] Code examples compile with claude-usage dependency

## Out of Scope

- Changing E009 implementation (just documentation)
- Merging epics

## Notes

### E009 Epic Updates

Add to Dependencies section:

```markdown
## Dependencies

- [E011 - Claude Usage Crate](./E011-claude-usage-crate.md) - Provides
  credential fetching and usage API client
```

Update Technical Notes section:

```markdown
### Data Source

API usage data is fetched using the `claude-usage` crate:

\`\`\`rust use claude_usage::get_usage;

let usage = get_usage()?; // usage.five_hour.utilization,
usage.seven_day.utilization, etc. \`\`\`

The daemon periodically fetches this data and broadcasts to connected clients.
```

### S009.02 Updates

Remove the credential fetching code examples and replace with:

```rust
// In daemon, periodically fetch usage
use claude_usage::get_usage;

fn refresh_usage(&self) -> Result<(), Error> {
    let usage = get_usage()?;
    self.broadcast_usage_update(usage);
    Ok(())
}
```

### Q34 Updates

Update the decision text:

```markdown
**Decision:** Implemented in E011 (claude-usage crate)

The claude-usage crate handles:

- macOS Keychain credential fetch
- Linux credential file fetch
- API call with proper headers
- Typed response parsing

E009 consumes this crate for usage data.
```

### Clear Separation

| Epic | Responsibility                          |
| ---- | --------------------------------------- |
| E011 | Fetch usage data from Anthropic API     |
| E009 | Track per-session usage, display in TUI |

E009's `ApiUsage` struct (per-session tokens) is different from E011's
`UsageData` struct (account-level quotas). Both are needed:

- E011: "You've used 77% of your 7-day quota"
- E009: "This session used 12,000 tokens"
