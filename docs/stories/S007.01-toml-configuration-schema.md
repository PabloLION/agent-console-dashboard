# Story: Define TOML Configuration Schema

**Story ID:** S007.01 **Epic:**
[E007 - Configuration System](../epic/E007-configuration-system.md) **Status:**
Draft **Priority:** P1 **Estimated Points:** 3

## Description

As a developer, I want a well-defined TOML configuration schema with Rust types,
So that configuration can be parsed, validated, and used throughout the
application.

## Context

The Agent Console Dashboard needs a centralized configuration system to manage
UI preferences, agent integrations, and daemon settings. TOML is chosen for its
readability and strong Rust ecosystem support (via `toml` and `serde` crates).
This story defines the schema structure and corresponding Rust types that will
be used by all other configuration-related functionality.

The schema must balance flexibility (supporting future extensions) with
simplicity (users shouldn't need to configure everything). All fields should
have sensible defaults, making configuration optional for most users.

Per
[E007 Technical Notes](../epic/E007-configuration-system.md#configuration-schema),
the schema consolidates ALL configurable values from across epics, including
daemon auto-stop timeout (60 min per D5), usage fetch interval (3 min per D4),
and hot-reloadable vs restart-required settings (Q27).

## Implementation Details

### Technical Approach

1. Define Rust structs with `serde::Deserialize` for each configuration section
2. Use `#[serde(default)]` for optional fields with sensible defaults
3. Implement `Default` trait for all config structs
4. Add validation logic for enum fields (layout types, widget names)
5. Create comprehensive doc comments explaining each field
6. Mark hot-reloadable vs restart-required fields in documentation

### Files to Modify

- `crates/agent-console-dashboard/src/config/mod.rs` - Create config module with
  schema types
- `crates/agent-console-dashboard/src/config/schema.rs` - Define configuration
  structs
- `crates/agent-console-dashboard/src/lib.rs` - Export config module
- `Cargo.toml` - Add `toml` and `serde` dependencies

### Dependencies

- None (this is foundational for E007)

## Acceptance Criteria

- [ ] Given a valid TOML configuration string, when parsed, then it deserializes
      into Config struct without errors
- [ ] Given a configuration with missing optional fields, when parsed, then
      default values are used
- [ ] Given a configuration with invalid enum values, when parsed, then a
      descriptive error is returned
- [ ] Given the schema types, when examined, then all fields have doc comments
      explaining their purpose and hot-reload behavior
- [ ] Given a Config struct, when serialized, then it produces valid TOML
      matching the schema
- [ ] Given the schema, when reviewed, then it supports all sections: `[ui]`,
      `[agents.*]`, `[integrations.*]`, `[daemon]`
- [ ] Given the daemon config, when validated, then `idle_timeout` defaults to
      60 minutes
- [ ] Given the daemon config, when validated, then `usage_fetch_interval`
      defaults to 3 minutes
- [ ] Given the schema, when reviewed, then it includes all fields from E007
      technical notes

## Testing Requirements

- [ ] Unit test: Parse valid configuration with all fields specified
- [ ] Unit test: Parse configuration with only required fields (defaults for
      rest)
- [ ] Unit test: Parse configuration with unknown fields (should be ignored or
      error based on design)
- [ ] Unit test: Validation rejects invalid layout values
- [ ] Unit test: Validation rejects invalid widget names
- [ ] Unit test: Default configuration values match documented defaults (60m
      idle, 3m fetch)
- [ ] Unit test: Log level enum parsing works correctly

## Out of Scope

- Loading configuration from file system (S007.02)
- XDG path resolution (S007.03)
- Creating default configuration file on disk (S007.04)
- Runtime configuration reloading
- Configuration file watching

## Notes

### Configuration Schema

Per [E007 epic](../epic/E007-configuration-system.md#configuration-schema), the
consolidated schema includes:

```toml
[ui]
layout = "two-line"  # or "one-line", "custom"
widgets = ["working-dir", "status", "api-usage"]
tick_rate = "250ms"  # TUI refresh rate

[agents.claude-code]
enabled = true
hooks_path = "~/.claude/hooks"

[integrations.zellij]
enabled = true

[daemon]
idle_timeout = "60m"          # Auto-stop after idle (D5 amendment)
usage_fetch_interval = "3m"   # API usage fetch interval (D4)
log_level = "info"            # Hot-reloadable
log_file = ""                 # Empty = stderr, path = file
```

### Rust Schema Types

```rust
use serde::Deserialize;
use std::time::Duration;

#[derive(Debug, Clone, Deserialize, Default)]
pub struct Config {
    #[serde(default)]
    pub ui: UiConfig,
    #[serde(default)]
    pub agents: AgentsConfig,
    #[serde(default)]
    pub integrations: IntegrationsConfig,
    #[serde(default)]
    pub daemon: DaemonConfig,
}

#[derive(Debug, Clone, Deserialize)]
pub struct UiConfig {
    #[serde(default = "default_layout")]
    pub layout: Layout,
    #[serde(default = "default_widgets")]
    pub widgets: Vec<String>,
    #[serde(default = "default_tick_rate")]
    pub tick_rate: String,
}

#[derive(Debug, Clone, Deserialize)]
#[serde(rename_all = "kebab-case")]
pub enum Layout {
    OneLine,
    TwoLine,
    Custom,
}

#[derive(Debug, Clone, Deserialize, Default)]
pub struct AgentsConfig {
    #[serde(default)]
    pub claude_code: ClaudeCodeConfig,
}

#[derive(Debug, Clone, Deserialize)]
pub struct ClaudeCodeConfig {
    #[serde(default = "default_true")]
    pub enabled: bool,
    #[serde(default = "default_hooks_path")]
    pub hooks_path: String,
}

#[derive(Debug, Clone, Deserialize, Default)]
pub struct IntegrationsConfig {
    #[serde(default)]
    pub zellij: ZellijConfig,
}

#[derive(Debug, Clone, Deserialize)]
pub struct ZellijConfig {
    #[serde(default = "default_true")]
    pub enabled: bool,
}

#[derive(Debug, Clone, Deserialize)]
pub struct DaemonConfig {
    /// Auto-stop after idle (default: 60 minutes per D5)
    /// Hot-reloadable: Yes
    #[serde(default = "default_idle_timeout")]
    pub idle_timeout: String,

    /// API usage fetch interval (default: 3 minutes per D4)
    /// Hot-reloadable: Yes
    #[serde(default = "default_usage_fetch_interval")]
    pub usage_fetch_interval: String,

    /// Log level (error, warn, info, debug, trace)
    /// Hot-reloadable: Yes
    #[serde(default = "default_log_level")]
    pub log_level: LogLevel,

    /// Log file location (empty = stderr)
    /// Hot-reloadable: No (restart required)
    #[serde(default)]
    pub log_file: String,
}

#[derive(Debug, Clone, Deserialize)]
#[serde(rename_all = "kebab-case")]
pub enum LogLevel {
    Error,
    Warn,
    Info,
    Debug,
    Trace,
}

fn default_idle_timeout() -> String {
    "60m".to_string()
}

fn default_usage_fetch_interval() -> String {
    "3m".to_string()
}

fn default_log_level() -> LogLevel {
    LogLevel::Info
}

fn default_true() -> bool {
    true
}

fn default_hooks_path() -> String {
    "~/.claude/hooks".to_string()
}

fn default_layout() -> Layout {
    Layout::TwoLine
}

fn default_widgets() -> Vec<String> {
    vec!["working-dir".to_string(), "status".to_string(), "api-usage".to_string()]
}

fn default_tick_rate() -> String {
    "250ms".to_string()
}
```

### Duration Parsing

The configuration uses human-readable duration strings (`"60m"`, `"3m"`) which
must be parsed into `std::time::Duration`. Consider using a duration parsing
helper or the `humantime` crate.

### Design Decisions

1. **Flat agent/integration structure**: Using `[agents.claude-code]` instead of
   arrays allows easy access and clear identification
2. **String widget list**: Widgets are specified by name (string) rather than
   complex structures for simplicity
3. **All fields optional**: Users can start with an empty config file and get
   sensible defaults
4. **Kebab-case enums**: More readable in TOML (`"two-line"` vs `"TwoLine"`)
5. **Hot-reload annotations**: Doc comments indicate which fields require daemon
   restart per Q27

### Future Extensions

The schema should be designed to accommodate:

- Additional agents beyond Claude Code
- Custom widget configurations
- Theme customization
- Notification settings
