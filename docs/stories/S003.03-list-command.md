# Story: Implement LIST Command

**Story ID:** S003.03 **Epic:**
[E003 - IPC Protocol & Client](../epic/E003-ipc-protocol-and-client.md)
**Status:** Draft **Priority:** P1 **Estimated Points:** 2

## Description

As a user or script, I want to query all current session states, So that I can
see a snapshot of all agent sessions without subscribing to updates.

## Context

The LIST command provides a one-shot query of all session states. Unlike
SUBSCRIBE which streams continuous updates, LIST returns the current state and
closes the connection. This is useful for:

- Scripts that need to check session states
- One-time queries from the command line
- Initial state load before subscribing
- Debugging and monitoring

The response is JSON for easy parsing by scripts while remaining human-readable.

## Implementation Details

### Technical Approach

1. Add LIST command handler in daemon server
2. Read all sessions from the store (read lock only)
3. Serialize sessions to JSON array
4. Return STATE response with JSON payload
5. Close connection after response (one-shot query)

### Protocol Format

```text
# Request
LIST

# Response
STATE <json>

# Example Response
STATE [{"id":"session-abc123","status":"working","elapsed":45,"working_dir":"/home/user/project"},{"id":"session-def456","status":"attention","elapsed":120}]
```

### Files to Modify

- `crates/agent-console-dashboard/src/daemon/server.rs` - Add LIST command
  handler
- `crates/agent-console-dashboard/src/daemon/store.rs` - Add method to serialize
  all sessions

### Dependencies

- [S003.01 - IPC Message Protocol](./S003.01-ipc-message-protocol.md) - Protocol
  definition
- [S001.03 - In-Memory Session Store](./S001.03-in-memory-session-store.md) -
  Store to query
- [S002.01 - Session Data Model](./S002.01-session-data-model.md) - Session
  serialization

## Acceptance Criteria

- [ ] Given sessions exist, when LIST is called, then all sessions are returned
      as JSON array
- [ ] Given no sessions exist, when LIST is called, then empty JSON array `[]`
      is returned
- [ ] Given sessions with various statuses, when LIST is called, then each
      session includes id, status, and elapsed time
- [ ] Given a LIST command, when processed, then response is prefixed with
      "STATE "
- [ ] Given a LIST command, when complete, then connection can be closed
      (one-shot)
- [ ] Given many sessions (100+), when LIST is called, then response completes
      in under 10ms

## Testing Requirements

- [ ] Unit test: LIST returns empty array when no sessions
- [ ] Unit test: LIST returns all sessions with correct fields
- [ ] Unit test: Session JSON includes required fields (id, status, elapsed)
- [ ] Unit test: Session JSON includes optional fields when present
      (working_dir, api_usage)
- [ ] Integration test: LIST over socket returns valid JSON
- [ ] Integration test: LIST response is parseable by jq

## Out of Scope

- Filtering sessions by status (future enhancement)
- Pagination for large result sets (not needed for expected session count)
- Historical data (only current state)
- Streaming updates (SUBSCRIBE command)

## Notes

### JSON Response Format

```json
[
  {
    "id": "session-abc123",
    "status": "working",
    "elapsed": 45,
    "working_dir": "/home/user/project",
    "api_usage": {
      "input_tokens": 1500,
      "output_tokens": 800
    }
  },
  {
    "id": "session-def456",
    "status": "attention",
    "elapsed": 120
  }
]
```

### Fields

| Field       | Type   | Required | Description                                        |
| ----------- | ------ | -------- | -------------------------------------------------- |
| id          | string | yes      | Session identifier                                 |
| status      | string | yes      | Current status (working/attention/question/closed) |
| elapsed     | number | yes      | Seconds in current status                          |
| working_dir | string | no       | Working directory path                             |
| api_usage   | object | no       | Token usage if tracked                             |
| session_id  | string | no       | Claude Code session ID for resume                  |

### CLI Usage

```bash
# Simple query
agent-console list

# Parse with jq
agent-console list | jq '.[] | select(.status == "attention")'

# Count working sessions
agent-console list | jq '[.[] | select(.status == "working")] | length'
```

### Performance

- Read lock only (no write contention)
- JSON serialization is fast for expected session counts (< 50 sessions)
- Single response, no streaming overhead
