# Story: Create Daemon Process with CLI Interface

**Story ID:** S001.01 **Epic:**
[E001 - Daemon Core Infrastructure](../epic/E001-daemon-core-infrastructure.md)
**Status:** Draft **Priority:** P1 **Estimated Points:** 5

## Description

As a developer, I want to create a daemon process with a CLI interface, So that
I have the foundation for the Agent Console backend service.

## Context

The daemon is the central hub of the Agent Console Dashboard system. It runs as
a long-lived process in either foreground mode (development/debugging) or
background mode (production). This story establishes the basic process structure
and CLI entry point using clap for argument parsing.

The daemon uses a **single-threaded actor model** with tokio for async I/O. All
state mutations flow through an mpsc message queue, processed sequentially by
one event loop. See [concurrency model](../architecture/concurrency.md).

The daemon was chosen over shared memory and SQLite alternatives because it
provides minimal footprint, real-time push updates, safe Rust (no `unsafe`
code), and a simple data model (HashMap in memory).

## Implementation Details

### Technical Approach

1. Set up project structure with Cargo.toml and dependencies (tokio, clap)
2. Create `main.rs` with CLI argument parsing using clap
3. Implement daemon subcommand with `--daemonize` and `--socket` flags
4. Create `daemon/mod.rs` as the daemon module entry point
5. Implement basic process lifecycle (start, signal handling, graceful shutdown)
6. Support both foreground and background (daemonized) modes
7. Set up tokio single-threaded runtime (not multi-threaded)

### Files to Create/Modify

- `Cargo.toml` - Add tokio (single-threaded), clap dependencies
- `crates/agent-console-dashboard/src/main.rs` - CLI entry point
- `crates/agent-console-dashboard/src/daemon/mod.rs` - Daemon module
- `crates/agent-console-dashboard/src/lib.rs` - Shared types if needed

### Dependencies

None (this is the first story in E001)

## Acceptance Criteria

- [ ] Given no daemon running, when `agent-console daemon` is executed, then the
      process starts in foreground mode
- [ ] Given the `--daemonize` flag, when the daemon starts, then it detaches
      from the terminal and runs in background
- [ ] Given the `--socket` flag, when the daemon starts, then it uses the
      specified socket path (default: `/tmp/agent-console.sock`)
- [ ] Given a running daemon, when SIGTERM/SIGINT is received, then the daemon
      shuts down gracefully
- [ ] Given the binary is built, then the resulting executable is under 10MB
- [ ] Given the daemon starts, then startup time is under 100ms
- [ ] Given the daemon initializes, then it uses a single-threaded tokio runtime
      (not default multi-threaded)

## Testing Requirements

- [ ] Unit test: CLI argument parsing handles all flags correctly
- [ ] Unit test: Default socket path is `/tmp/agent-console.sock`
- [ ] Integration test: Daemon starts and responds to shutdown signals
- [ ] Integration test: Foreground mode blocks until signal received

## Out of Scope

- Socket server implementation (S001.02)
- Session store implementation (S001.03)
- Auto-start capability (S001.04)
- Auto-stop timeout logic (implemented later)
- IPC protocol handling

## Notes

### CLI Interface

```bash
# Start daemon (foreground, for development)
agent-console daemon

# Start daemon (background)
agent-console daemon --daemonize

# With custom socket path
agent-console daemon --socket /tmp/agent-console.sock
```

### Project Structure

```text
src/
├── main.rs           # CLI entry, argument parsing
├── daemon/
│   └── mod.rs        # Daemon module entry
└── lib.rs            # Shared types
```

### Key Dependencies

| Crate | Purpose                          |
| ----- | -------------------------------- |
| tokio | Async runtime (single-threaded!) |
| clap  | CLI argument parsing             |

### Tokio Runtime Configuration

Use `tokio::runtime::Builder` to create a single-threaded runtime:

```rust
#[tokio::main(flavor = "current_thread")]
async fn main() {
    // Single-threaded runtime for actor model
}
```

Or explicitly:

```rust
let runtime = tokio::runtime::Builder::new_current_thread()
    .enable_all()
    .build()
    .unwrap();
```

### Graceful Shutdown Mechanisms

Per epic and [E001 technical notes](../epic/E001-daemon-core-infrastructure.md):

| Mechanism          | Behavior                                  |
| ------------------ | ----------------------------------------- |
| `acd stop`         | Warns if dashboards connected, then stops |
| `acd stop --force` | Stops immediately                         |
| SIGTERM/SIGINT     | Graceful shutdown (same as `acd stop`)    |
| SIGHUP             | Reload configuration                      |
| Auto-stop          | After 60 min idle (configurable)          |
