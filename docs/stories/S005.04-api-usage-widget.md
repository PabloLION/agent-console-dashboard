# Story: Implement API Usage Widget

**Story ID:** S005.04 **Epic:**
[E005 - Widget System](../epic/E005-widget-system.md) **Status:** Draft
**Priority:** P2 **Estimated Points:** 2

## Description

As a user, I want an api-usage widget in the dashboard, So that I can see my
account-level quota utilization at a glance.

## Context

The api-usage widget renders account-level 5h and 7d quota utilization fetched
by the `claude-usage` crate (E011). Data flows from S009.01 (periodic fetch into
TUI state) through this widget for rendering. S009.03 defines the display format
and color thresholds; this story implements the Widget trait wrapper that plugs
into the layout system (E005).

This widget reads from `WidgetContext.usage` (an `Option<UsageResponse>`) and
delegates formatting to the helpers defined in S009.03.

## Implementation Details

### Technical Approach

1. Create `crates/agent-console-dashboard/src/widgets/api_usage.rs`
2. Implement Widget trait for ApiUsageWidget
3. Read `UsageResponse` from `WidgetContext`
4. Render 5h/7d quota percentages with color coding
5. Support compact and full display modes based on width
6. Show placeholder when data is unavailable

### Files to Modify

- `crates/agent-console-dashboard/src/widgets/api_usage.rs` — ApiUsageWidget
  implementation
- `crates/agent-console-dashboard/src/widgets/mod.rs` — export and register
  api-usage widget

### Dependencies

- [S005.01 - Widget Trait/Interface](./S005.01-widget-trait-interface.md) \-
  Widget trait to implement
- [S009.01 - Integrate claude-usage Crate](./S009.01-api-usage-data-model.md) \-
  provides `UsageResponse` in TUI state
- [S009.03 - Display Usage in TUI](./S009.03-api-usage-tui-display.md) \-
  defines display format and color thresholds

## Acceptance Criteria

- [ ] Given usage data is available in `WidgetContext`, when widget renders,
      then 5h and 7d utilization percentages are displayed
- [ ] Given terminal width is 30+ columns, when widget renders, then full format
      is used: `Quota: 5h 8% | 7d 77% | resets 2h 15m`
- [ ] Given terminal width is under 30 columns, when widget renders, then
      compact format is used: `[5h:8% 7d:77%]`
- [ ] Given no usage data is available, when widget renders, then `Quota: --`
      placeholder is shown
- [ ] Given 5h utilization exceeds 80%, when widget renders, then yellow color
      is applied
- [ ] Given 5h utilization exceeds 95%, when widget renders, then red color is
      applied
- [ ] Given the widget is registered, when layout includes `api-usage`, then it
      renders correctly in all presets

## Testing Requirements

- [ ] Unit test: Full format renders correct string for sample UsageResponse
- [ ] Unit test: Compact format renders correct string
- [ ] Unit test: Placeholder displays when no data available
- [ ] Unit test: Width constraint selects correct format
- [ ] Unit test: Color thresholds apply correctly (green/yellow/red)

## Out of Scope

- Per-session token tracking (no data source available)
- USD cost estimates (removed per E009 revision)
- Historical usage graphs
- Usage alerts or notifications
- Token count display (replaced by quota percentages)

## Notes

### Relationship to S009.03

S009.03 (E009) defines the display format and formatting helpers. This story
(E005) implements the Widget trait wrapper that integrates those helpers into
the layout/widget system. The split exists because E005 owns widget architecture
and E009 owns usage display logic.

### Implementation

```rust
use ratatui::prelude::*;
use crate::widgets::{Widget, WidgetContext};
use claude_usage::types::UsageResponse;

pub struct ApiUsageWidget;

impl ApiUsageWidget {
    pub fn new() -> Self {
        Self
    }

    fn format_full(&self, usage: &UsageResponse) -> Line<'_> {
        let h5 = usage.five_hour.utilization;
        let d7 = usage.seven_day.utilization;
        let reset = format_reset_time(usage.five_hour.resets_at);

        let h5_color = utilization_color(h5);
        let d7_color = utilization_color(d7);

        Line::from(vec![
            Span::raw("Quota: 5h "),
            Span::styled(
                format!("{:.0}%", h5),
                Style::default().fg(h5_color),
            ),
            Span::raw(" | 7d "),
            Span::styled(
                format!("{:.0}%", d7),
                Style::default().fg(d7_color),
            ),
            Span::raw(&format!(" | resets {}", reset)),
        ])
    }

    fn format_compact(&self, usage: &UsageResponse) -> Line<'_> {
        let h5 = usage.five_hour.utilization;
        let d7 = usage.seven_day.utilization;

        Line::from(vec![
            Span::raw("[5h:"),
            Span::styled(
                format!("{:.0}%", h5),
                Style::default().fg(utilization_color(h5)),
            ),
            Span::raw(" 7d:"),
            Span::styled(
                format!("{:.0}%", d7),
                Style::default().fg(utilization_color(d7)),
            ),
            Span::raw("]"),
        ])
    }
}

fn utilization_color(pct: f64) -> Color {
    if pct > 95.0 {
        Color::Red
    } else if pct > 80.0 {
        Color::Yellow
    } else {
        Color::Green
    }
}

impl Widget for ApiUsageWidget {
    fn render(&self, width: u16, context: &WidgetContext) -> Line<'_> {
        match &context.usage {
            Some(usage) => {
                if width < 30 {
                    self.format_compact(usage)
                } else {
                    self.format_full(usage)
                }
            }
            None => Line::from(Span::styled(
                "Quota: --",
                Style::default().fg(Color::DarkGray),
            )),
        }
    }

    fn id(&self) -> &'static str {
        "api-usage"
    }

    fn min_width(&self) -> u16 {
        18
    }
}
```

### Color Thresholds

| Utilization | Color  |
| ----------- | ------ |
| < 80%       | Green  |
| 80% - 95%   | Yellow |
| > 95%       | Red    |

Thresholds match S009.03 for consistency.
