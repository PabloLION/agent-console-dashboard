# Story: Create User Prompt Submit Hook Script

**Story ID:** S006.02 **Epic:**
[E006 - Claude Code Integration](../epic/E006-claude-code-integration.md)
**Status:** Draft **Priority:** P1 **Estimated Points:** 2

## Description

As a user, I want a hook script that runs when I submit a prompt to Claude Code,
So that my dashboard shows which sessions are actively working.

## Context

The UserPromptSubmit hook is fired by Claude Code whenever the user sends a new
message or prompt. This signals that Claude is now processing the request and
actively working. The dashboard should immediately reflect this state change by
setting the session status to "Working".

Claude Code passes JSON data via stdin to ALL hook types, including the
`session_id` field which uniquely identifies the session. Hooks must parse this
JSON to extract `session_id` (not derive it from `basename $PWD`). See
[discussion decision D8](../architecture/2026-01-31-discussion-decisions.md).

This hook is essential for the core workflow: when managing multiple sessions,
users need to know which ones are actively processing versus waiting for input.
The "Working" status (displayed as `-` in green) indicates the session is busy
and doesn't need attention.

## Implementation Details

### Technical Approach

1. Create `scripts/hooks/user-prompt-submit.sh` (template for users to copy)
2. Script reads JSON from stdin using `cat` and `jq`
3. Script extracts `session_id` field from JSON
4. Script calls `agent-console set <session_id> working` to update status
5. Script must be executable and use `/bin/bash` shebang
6. Include comments explaining usage and customization options

### Files to Modify

- `scripts/hooks/user-prompt-submit.sh` - Create the user-prompt-submit hook
  script template
- `scripts/hooks/README.md` - Update hook documentation (if exists)

### Dependencies

- [E001 - Daemon Core Infrastructure](../epic/E001-daemon-core-infrastructure.md) -
  Daemon must be running
- [S003.02 - SET Command](./S003.02-set-command.md) - CLI SET command must work
- [S003.05 - CLI Client Commands](./S003.05-cli-client-commands.md) -
  agent-console CLI must be installed
- [S006.01 - Stop Hook Script](./S006.01-stop-hook-script.md) - Follows same
  pattern

## Acceptance Criteria

- [ ] Given the user-prompt-submit.sh script exists, when copied to
      `~/.claude/hooks/`, then it is ready to use
- [ ] Given Claude Code invokes the hook with JSON stdin, when the script runs,
      then `session_id` is extracted from JSON
- [ ] Given `session_id` is extracted, when script runs, then
      `agent-console set <session_id> working` is called
- [ ] Given the agent-console daemon is not running, when hook is invoked, then
      script fails gracefully (no crash)
- [ ] Given a session was in "Attention" status, when user submits a prompt,
      then status changes to "Working"
- [ ] Given the script runs, when completed, then it exits with status 0 on
      success

## Testing Requirements

- [ ] Manual test: Copy script to `~/.claude/hooks/user-prompt-submit.sh` and
      verify it executes
- [ ] Manual test: Provide sample JSON stdin and verify session_id extraction
- [ ] Manual test: Verify status transition from Attention to Working in
      dashboard
- [ ] Manual test: Run script when daemon is not running to verify graceful
      failure

## Out of Scope

- Tracking the content of the user's prompt
- Rate limiting multiple rapid submissions
- Custom status messages beyond "working"
- Windows support (bash scripts only)

## Notes

### Script Template

```bash
#!/bin/bash
# Agent Console Dashboard - UserPromptSubmit Hook for Claude Code
#
# This script is invoked when a user submits a prompt to Claude Code.
# It sets the session status to "Working" in the dashboard.
#
# Installation:
#   1. Copy this file to ~/.claude/hooks/user-prompt-submit.sh
#   2. Make it executable: chmod +x ~/.claude/hooks/user-prompt-submit.sh
#   3. Register in ~/.claude/settings.json (see S006.04)
#
# Customization:
#   - Add timestamp logging for session activity tracking

# Read JSON stdin and extract session_id
INPUT=$(cat)
SESSION_ID=$(echo "$INPUT" | jq -r '.session_id')

# Update dashboard status
agent-console set "$SESSION_ID" working
```

### JSON Stdin Format

Claude Code passes JSON to ALL hook types via stdin. Example for
UserPromptSubmit:

```json
{
  "session_id": "abc123-def456-ghi789",
  "cwd": "/home/user/projects/api-server",
  "transcript_path": "/home/user/.claude/transcripts/abc123.md",
  "permission_mode": "ask",
  "hook_event_name": "UserPromptSubmit",
  "prompt": "Add error handling to the API endpoint"
}
```

The script extracts `session_id` directly from JSON.

### Status Transition Flow

```text
[Any Status] --user submits prompt--> [Working]
[Working] --claude stops/completes--> [Attention]
```

This hook creates the first half of the automatic status cycling. Combined with
the Stop hook (S006.01), it provides a complete picture of session activity:

1. User sends prompt → Status: Working (green `-`)
2. Claude processes and responds
3. Claude stops/completes → Status: Attention (yellow time elapsed)
4. User sends next prompt → Back to Working

### Performance Considerations

This hook may be called frequently during active sessions. The script should:

- Execute quickly (avoid unnecessary operations)
- Not block Claude Code's operation
- Handle rapid successive calls gracefully

### Session Identification

**Decision D8:** Claude Code exposes `session_id` in JSON stdin to ALL hook
types. This is the primary session identifier.

Hooks MUST parse stdin JSON to extract `session_id`. The `basename "$PWD"`
pattern in older documentation is stale and incorrect.
