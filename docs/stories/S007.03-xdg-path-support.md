# Story: Add XDG Path Support

**Story ID:** S007.03 **Epic:**
[E007 - Configuration System](../epic/E007-configuration-system.md) **Status:**
Draft **Priority:** P2 **Estimated Points:** 2

## Description

As a user, I want the application to follow XDG Base Directory conventions, So
that configuration and runtime files are stored in standard locations on my Unix
system.

## Context

The XDG Base Directory Specification defines standard locations for
configuration, data, cache, and runtime files on Unix-like systems. Following
this specification ensures the Agent Console Dashboard integrates well with
existing tools and user expectations. Users can override default locations via
environment variables (`XDG_CONFIG_HOME`, `XDG_RUNTIME_DIR`, etc.), enabling
flexible deployment scenarios.

This story implements path resolution for all XDG directories used by the
application: configuration files, runtime socket, and potential cache/data
directories for future use.

## Implementation Details

### Technical Approach

1. Create `xdg` module with path resolution functions
2. Use `dirs` or `directories` crate for cross-platform XDG support
3. Provide functions for each XDG directory type with fallback defaults
4. Expand `~` in user-provided paths (e.g., from configuration)
5. Create directories if they don't exist (with appropriate permissions)

### Files to Modify

- `crates/agent-console-dashboard/src/config/xdg.rs` - Create XDG path
  resolution module
- `crates/agent-console-dashboard/src/config/mod.rs` - Export xdg module
- `Cargo.toml` - Add `dirs` or `directories` dependency

### Dependencies

- None (this is a utility module)

## Acceptance Criteria

- [ ] Given `$XDG_CONFIG_HOME` is set, when resolving config path, then it uses
      `$XDG_CONFIG_HOME/agent-console/config.toml`
- [ ] Given `$XDG_CONFIG_HOME` is not set, when resolving config path, then it
      uses `~/.config/agent-console/config.toml`
- [ ] Given `$XDG_RUNTIME_DIR` is set, when resolving socket path, then it uses
      `$XDG_RUNTIME_DIR/agent-console.sock`
- [ ] Given `$XDG_RUNTIME_DIR` is not set, when resolving socket path, then it
      uses `/tmp/agent-console.sock`
- [ ] Given a path starting with `~`, when expanded, then `~` is replaced with
      the user's home directory
- [ ] Given the config directory doesn't exist, when ensuring path, then
      directory is created with mode 0700
- [ ] Given the runtime directory doesn't exist, when ensuring socket path, then
      parent directory is created

## Testing Requirements

- [ ] Unit test: Config path with XDG_CONFIG_HOME set
- [ ] Unit test: Config path with XDG_CONFIG_HOME unset
- [ ] Unit test: Runtime path with XDG_RUNTIME_DIR set
- [ ] Unit test: Runtime path with XDG_RUNTIME_DIR unset
- [ ] Unit test: Tilde expansion in paths
- [ ] Integration test: Directory creation on first run

## Out of Scope

- Windows-specific path handling (Unix-only for v0)
- Caching or data directories (only config and runtime for now)
- Path migration from old locations
- Multiple configuration file locations (search path)

## Notes

### XDG Directories Used

| Purpose          | XDG Variable      | Default          |
| ---------------- | ----------------- | ---------------- |
| Configuration    | `XDG_CONFIG_HOME` | `~/.config`      |
| Runtime (socket) | `XDG_RUNTIME_DIR` | `/tmp`           |
| Data (future)    | `XDG_DATA_HOME`   | `~/.local/share` |
| Cache (future)   | `XDG_CACHE_HOME`  | `~/.cache`       |

### Implementation

```rust
use std::path::PathBuf;
use std::env;

/// Application name used in XDG paths
const APP_NAME: &str = "agent-console";

/// Get the configuration directory path
pub fn config_dir() -> PathBuf {
    env::var("XDG_CONFIG_HOME")
        .map(PathBuf::from)
        .unwrap_or_else(|_| {
            dirs::home_dir()
                .expect("Could not determine home directory")
                .join(".config")
        })
        .join(APP_NAME)
}

/// Get the configuration file path
pub fn config_path() -> PathBuf {
    config_dir().join("config.toml")
}

/// Get the runtime directory path (for socket)
pub fn runtime_dir() -> PathBuf {
    env::var("XDG_RUNTIME_DIR")
        .map(PathBuf::from)
        .unwrap_or_else(|_| PathBuf::from("/tmp"))
}

/// Get the Unix socket path
pub fn socket_path() -> PathBuf {
    runtime_dir().join("agent-console.sock")
}

/// Expand tilde in a path string
pub fn expand_tilde(path: &str) -> PathBuf {
    if path.starts_with("~/") {
        dirs::home_dir()
            .expect("Could not determine home directory")
            .join(&path[2..])
    } else if path == "~" {
        dirs::home_dir()
            .expect("Could not determine home directory")
    } else {
        PathBuf::from(path)
    }
}

/// Ensure a directory exists, creating it if necessary
pub fn ensure_dir(path: &PathBuf) -> std::io::Result<()> {
    if !path.exists() {
        std::fs::create_dir_all(path)?;
        // Set directory permissions to 0700 on Unix
        #[cfg(unix)]
        {
            use std::os::unix::fs::PermissionsExt;
            std::fs::set_permissions(path, std::fs::Permissions::from_mode(0o700))?;
        }
    }
    Ok(())
}

/// Ensure the config directory exists
pub fn ensure_config_dir() -> std::io::Result<PathBuf> {
    let dir = config_dir();
    ensure_dir(&dir)?;
    Ok(dir)
}
```

### Usage in Configuration Loading

```rust
// In config loader
let config_path = xdg::config_path();
let config = ConfigLoader::load_from_path(&config_path)?;

// Expand paths from config
let hooks_path = xdg::expand_tilde(&config.agents.claude_code.hooks_path);
```

### Tilde Expansion

User-provided paths in configuration may use `~` for home directory:

```toml
[agents.claude-code]
hooks_path = "~/.claude/hooks"  # Needs expansion
```

The `expand_tilde` function handles this common pattern.

### Directory Permissions

Configuration directories should be created with restricted permissions (0700)
to protect potentially sensitive configuration data. Runtime directories inherit
permissions from `XDG_RUNTIME_DIR` which is typically already restricted.

### Testing with Environment Variables

```rust
#[test]
fn test_config_path_with_xdg() {
    std::env::set_var("XDG_CONFIG_HOME", "/custom/config");
    let path = xdg::config_path();
    assert_eq!(path, PathBuf::from("/custom/config/agent-console/config.toml"));
    std::env::remove_var("XDG_CONFIG_HOME");
}
```
