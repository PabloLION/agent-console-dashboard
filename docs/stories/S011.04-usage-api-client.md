# Story: Usage API Client

**Story ID:** S011.04 **Epic:**
[E011 - Claude Usage Crate](../epic/E011-claude-usage-crate.md) **Status:**
Draft **Priority:** P0 **Estimated Points:** 3

## Description

As a developer, I want the claude-usage crate to call the Anthropic usage API,
So that I can retrieve current usage data with a single function call.

## Context

Anthropic provides an OAuth usage API that returns current utilization
percentages for 5-hour and 7-day windows. This story implements the HTTP client
that calls this API using the credentials retrieved in previous stories.

## Implementation Details

### Technical Approach

1. Use `reqwest` with blocking or async client
2. Call `GET https://api.anthropic.com/api/oauth/usage`
3. Include required headers: `Authorization: Bearer <token>` and
   `anthropic-beta: oauth-2025-04-20`
4. Handle HTTP errors (401, 429, 5xx)
5. Return raw JSON response for parsing in S011.05
6. Provide both sync and async APIs

### API Details

```text
GET https://api.anthropic.com/api/oauth/usage
Authorization: Bearer <token>
anthropic-beta: oauth-2025-04-20
```

### Files to Create/Modify

- `crates/claude-usage/src/client.rs` - HTTP client implementation
- `crates/claude-usage/src/lib.rs` - Export client module

### Dependencies

- [S011.02 - macOS Credential Fetch](./S011.02-macos-credential-fetch.md)
- [S011.03 - Linux Credential Fetch](./S011.03-linux-credential-fetch.md)

## Acceptance Criteria

- [ ] Given valid credentials, when `fetch_usage()` is called, then API response
      is returned
- [ ] Given expired/invalid token, when API returns 401, then `Unauthorized`
      error is returned with re-login guidance
- [ ] Given rate limit hit, when API returns 429, then `RateLimited` error is
      returned with retry-after info
- [ ] Given server error, when API returns 5xx, then `ServerError` is returned
- [ ] Given network failure, when request fails, then `NetworkError` is returned
- [ ] Given successful call, when function returns, then token is not retained

## Testing Requirements

- [ ] Unit test: Correct headers are set on request
- [ ] Unit test: 401 response maps to Unauthorized error
- [ ] Unit test: 429 response maps to RateLimited error
- [ ] Unit test: 5xx response maps to ServerError
- [ ] Integration test: Real API call with valid credentials (manual/CI skip)

## Out of Scope

- Response parsing (S011.05)
- Caching
- Automatic retry logic
- Token refresh

## Notes

### Implementation

```rust
use reqwest::blocking::Client;

const USAGE_API_URL: &str = "https://api.anthropic.com/api/oauth/usage";
const BETA_HEADER: &str = "oauth-2025-04-20";

pub fn fetch_usage_raw(token: &str) -> Result<String, ApiError> {
    let client = Client::new();

    let response = client
        .get(USAGE_API_URL)
        .header("Authorization", format!("Bearer {}", token))
        .header("anthropic-beta", BETA_HEADER)
        .send()
        .map_err(|e| ApiError::Network(e.to_string()))?;

    match response.status().as_u16() {
        200 => response.text().map_err(|e| ApiError::Network(e.to_string())),
        401 => Err(ApiError::Unauthorized),
        429 => {
            let retry_after = response
                .headers()
                .get("retry-after")
                .and_then(|v| v.to_str().ok())
                .map(String::from);
            Err(ApiError::RateLimited { retry_after })
        }
        500..=599 => Err(ApiError::Server(response.status().as_u16())),
        code => Err(ApiError::Unexpected(code)),
    }
}
```

### Async Version

```rust
pub async fn fetch_usage_raw_async(token: &str) -> Result<String, ApiError> {
    let client = reqwest::Client::new();
    // ... same logic with .await
}
```

### Error Types

```rust
#[derive(Debug, thiserror::Error)]
pub enum ApiError {
    #[error("Network error: {0}")]
    Network(String),

    #[error("Unauthorized. Run `claude` to re-login.")]
    Unauthorized,

    #[error("Rate limited. Retry after: {retry_after:?}")]
    RateLimited { retry_after: Option<String> },

    #[error("Server error: {0}")]
    Server(u16),

    #[error("Unexpected status code: {0}")]
    Unexpected(u16),
}
```

### Feature Flags

Consider feature flags for async support:

```toml
[features]
default = ["blocking"]
blocking = ["reqwest/blocking"]
async = ["reqwest"]
```
