# Story: Zellij Resurrection Workflow

**Story ID:** S010.02 **Epic:**
[E010 - Zellij Integration](../epic/E010-zellij-integration.md)
**Status:** Draft **Priority:** P2 **Estimated Points:** 3

## Description

As a Zellij user, I want to resurrect closed Claude Code sessions directly into Zellij panes, So that resumed sessions appear in new panes without manual terminal management.

## Context

Session resurrection (E008) enables users to bring back closed Claude Code sessions. When working in Zellij, the workflow should integrate with Zellij's pane system: creating a new pane and automatically running `claude --resume <session-id>` there.

This story focuses on the Zellij-specific pane management aspect of resurrection. The core resurrection command and protocol are handled in E008; this story bridges that capability into the Zellij environment.

## Implementation Details

### Technical Approach

1. Detect if running inside Zellij via `$ZELLIJ` environment variable
2. When resurrection is triggered from TUI (inside Zellij), use `zellij action new-pane` to create a pane
3. Execute `claude --resume <session-id>` in that new pane
4. Fallback: If not in Zellij, display the command for user to copy/paste
5. Update daemon state after resurrection is triggered (session → Working)

### Pane Strategy

Create new pane in current tab (default behavior). This is the simplest and most predictable:

```bash
zellij action new-pane -- claude --resume <session-id>
```

Future enhancements could add pane positioning options.

### Files to Create

- `crates/agent-console-dashboard/src/integrations/zellij.rs` - Zellij CLI wrapper module

### Files to Modify

- `crates/agent-console-dashboard/src/tui/handlers.rs` - Handle resurrection keypress in TUI
- `crates/agent-console-dashboard/src/tui/ui.rs` - Display resurrection instructions when not in Zellij

### Dependencies

- S008.01: Closed session metadata must be stored
- S008.02: RESURRECT IPC command must be implemented
- S010.01: Zellij layout integration (base)
- S010.03: Terminal command execution logic

## Acceptance Criteria

- [ ] Given user presses 'r' on a closed session in TUI inside Zellij, then new pane is created with `claude --resume <session-id>`
- [ ] Given user triggers resurrection outside Zellij, then command is displayed for manual execution
- [ ] Given pane creation succeeds, then dashboard status updates to show session as Working
- [ ] Given `zellij` command fails (not installed, not in Zellij), then graceful fallback to displaying command
- [ ] Given session working directory, then `claude --resume` runs with `--cwd <dir>` flag
- [ ] Given Zellij pane creation fails, then error message is shown and command is displayed

## Testing Requirements

- [ ] Manual test: Resurrection creates new Zellij pane with resumed session
- [ ] Manual test: Dashboard updates status after resurrection
- [ ] Manual test: Fallback works outside Zellij (displays command)
- [ ] Manual test: Error handling when Zellij CLI unavailable
- [ ] Integration test: Zellij environment detection works correctly

## Out of Scope

- Pane positioning/naming (new pane uses default Zellij behavior)
- Multiple simultaneous resurrections
- Automatic pane focus or switching
- tmux resurrection workflow (separate feature)
- Native Zellij plugin resurrection (v2+ feature)

## Notes

### Zellij Detection

```rust
pub fn is_inside_zellij() -> bool {
    std::env::var("ZELLIJ").is_ok()
}
```

### Resurrection Flow

```text
User presses 'r' in TUI (on closed session)
           │
           ▼
    ┌──────────────────┐
    │ Check if inside  │
    │ Zellij ($ZELLIJ) │
    └────────┬─────────┘
             │
      Yes ───┴─── No
       │           │
       ▼           ▼
┌─────────────┐ ┌──────────────────────┐
│ Create pane │ │ Display command:     │
│ via zellij  │ │ "claude --resume..." │
│ CLI         │ │ for user to copy     │
└──────┬──────┘ └──────────────────────┘
       │
       ▼
┌─────────────────┐
│ Send RESURRECT  │
│ to daemon       │
└────────┬────────┘
         │
         ▼
┌──────────────────┐
│ Dashboard shows  │
│ session: Working │
└──────────────────┘
```

### Zellij CLI Integration

```rust
// src/integrations/zellij.rs

use std::process::Command;

/// Check if running inside Zellij
pub fn is_inside_zellij() -> bool {
    std::env::var("ZELLIJ").is_ok()
}

/// Create new Zellij pane and run command
pub fn create_pane_with_command(cmd: &str, args: &[&str]) -> Result<(), ZellijError> {
    let mut command = Command::new("zellij");
    command.args(["action", "new-pane", "--"]);
    command.arg(cmd);
    command.args(args);

    let status = command.status()
        .map_err(|e| ZellijError::CommandFailed(e.to_string()))?;

    if status.success() {
        Ok(())
    } else {
        Err(ZellijError::PaneCreationFailed)
    }
}

#[derive(Debug, thiserror::Error)]
pub enum ZellijError {
    #[error("Failed to create Zellij pane")]
    PaneCreationFailed,

    #[error("Command execution failed: {0}")]
    CommandFailed(String),
}
```

### TUI Handler Example

```rust
// In TUI key handler for 'r' (resurrect)

fn handle_resurrect_key(&mut self, session_id: &str, working_dir: &Path) -> Result<()> {
    if zellij::is_inside_zellij() {
        // Create pane with resume command
        let args = vec![
            "--resume", session_id,
            "--cwd", working_dir.to_str().unwrap()
        ];

        match zellij::create_pane_with_command("claude", &args) {
            Ok(_) => {
                // Notify daemon
                self.send_resurrect_command(session_id)?;
                self.status_message = "Session resurrecting in new pane".to_string();
            }
            Err(e) => {
                // Fallback to displaying command
                let cmd = format!("claude --resume {} --cwd {}", session_id, working_dir.display());
                self.status_message = format!("Run: {}", cmd);
            }
        }
    } else {
        // Not in Zellij, show command
        let cmd = format!("claude --resume {} --cwd {}", session_id, working_dir.display());
        self.status_message = format!("Run: {}", cmd);
    }

    Ok(())
}
```

### Fallback Display

When not in Zellij or pane creation fails, display clear instructions:

```text
┌─────────────────────────────────────────────────┐
│ Session: my-project                             │
│                                                 │
│ To resume, run:                                 │
│   claude --resume abc123 --cwd /path/to/project │
│                                                 │
│ (Press 'y' to copy command to clipboard)        │
└─────────────────────────────────────────────────┘
```

### Configuration Options

Future enhancement - allow users to configure pane behavior:

```toml
[integrations.zellij]
enabled = true
# auto_pane = true          # Auto-create panes for resurrection
# pane_position = "right"   # Where to create new panes
```

### Error Messages

| Error | Message | Action |
|-------|---------|--------|
| Zellij not detected | "Not in Zellij. Command: claude --resume ..." | Display command |
| Pane creation failed | "Failed to create pane. Command: claude --resume ..." | Display command |
| Session not found | "Session 'abc123' not found" | Show error in status line |
