# Story: Document Zellij Resurrection Workflow

**Story ID:** S010.02 **Epic:**
[E010 - Zellij Integration](../epic/E010-zellij-integration.md) **Status:**
Draft **Priority:** P2 **Estimated Points:** 5

## Description

As a user, I want to resurrect closed Claude Code sessions within Zellij panes,
So that I can seamlessly continue previous work without manually navigating
terminals.

## Context

Session resurrection (E008) allows users to bring back closed Claude Code
sessions using `claude --resume <session-id>`. When working within Zellij, this
workflow should integrate with Zellij's pane management - either creating new
panes for resurrected sessions or sending the resume command to an existing
pane.

This story documents and implements the resurrection workflow within the Zellij
context, building on the Zellij layout integration (S010.01) and the core
resurrection command (S008.02).

## Implementation Details

### Technical Approach

1. Detect Zellij environment before resurrection
2. Implement pane creation for new session via Zellij CLI
3. Implement command execution in existing pane via Zellij CLI
4. Support different resurrection strategies (new pane, focused pane, specified
   pane)
5. Update dashboard status after resurrection triggers
6. Handle errors gracefully (Zellij not available, pane creation fails)
7. Document the workflow for users

### Files to Create

- `scripts/resurrect-in-zellij.sh` - Shell script for Zellij-aware resurrection
- `docs/resurrection-workflow.md` - User documentation for resurrection

### Files to Modify

- `crates/agent-console-dashboard/src/cli/commands/resurrect.rs` - Add Zellij integration flag
- `crates/agent-console-dashboard/src/integrations/zellij.rs` - Zellij CLI wrapper module

### Dependencies

- [S008.01 - Store Session Metadata for Closed Sessions](./S008.01-closed-session-metadata.md)
  \- Closed session data
- [S008.02 - Implement RESURRECT Command](./S008.02-resurrect-command.md) - Core
  resurrection IPC command
- [S008.03 - Integrate with claude --resume](./S008.03-claude-resume-integration.md) -
  Claude Code resume command
- [S010.01 - Zellij Layout with Dashboard Pane](./S010.01-zellij-layout-dashboard.md) -
  Zellij integration base

## Acceptance Criteria

- [ ] Given user runs `agent-console resurrect <session>` inside Zellij, then a
      new pane is created with the resumed session
- [ ] Given user runs resurrection with `--pane current` flag, then the resume
      command runs in the currently focused pane
- [ ] Given user runs resurrection with `--pane new` flag, then a new Zellij
      pane is created
- [ ] Given user runs resurrection outside Zellij, then resurrection proceeds in
      current terminal (fallback)
- [ ] Given Zellij pane creation fails, then a helpful error message is
      displayed
- [ ] Given session is resurrected, then dashboard status updates to "Working"
      within 2 seconds
- [ ] Given the `ZELLIJ` environment variable is not set, then Zellij features
      are disabled gracefully

## Testing Requirements

- [ ] Manual test: Resurrection creates new pane in Zellij
- [ ] Manual test: Resurrection runs in current pane with flag
- [ ] Manual test: Dashboard updates after resurrection
- [ ] Manual test: Resurrection works outside Zellij (fallback)
- [ ] Manual test: Error handling when Zellij commands fail
- [ ] Integration test: Zellij detection works correctly

## Out of Scope

- Automatic pane selection based on session context
- Pane naming or labeling with session ID
- Multiple simultaneous resurrections
- Zellij plugin-based resurrection

## Notes

### Resurrection Strategies

| Strategy      | Flag                             | Behavior                            |
| ------------- | -------------------------------- | ----------------------------------- |
| New Pane      | `--pane new` (default in Zellij) | Creates new pane, runs resume there |
| Current Pane  | `--pane current`                 | Runs resume in focused pane         |
| Specific Pane | `--pane-id <id>`                 | Sends command to specific pane      |
| Auto          | (outside Zellij)                 | Runs in current terminal            |

### Zellij CLI Commands

```bash
# Create new pane and run command
zellij action new-pane -- claude --resume abc123

# Write command to existing pane
zellij action write 2 "claude --resume abc123\n"

# Focus a specific pane
zellij action focus-pane --pane-id 2

# Get current pane info
zellij action dump-layout
```

### Resurrection Shell Script

```bash
#!/bin/bash
# resurrect-in-zellij.sh

SESSION_ID="${1:?Session ID required}"
PANE_STRATEGY="${2:-new}"

# Check if inside Zellij
if [ -z "$ZELLIJ" ]; then
    echo "Not running in Zellij, using current terminal"
    claude --resume "$SESSION_ID"
    exit 0
fi

case "$PANE_STRATEGY" in
    "new")
        # Create new pane with the resume command
        zellij action new-pane -- claude --resume "$SESSION_ID"
        ;;
    "current")
        # Run in current pane (requires user to be in right pane)
        claude --resume "$SESSION_ID"
        ;;
    "pane:"*)
        # Extract pane ID and write to it
        PANE_ID="${PANE_STRATEGY#pane:}"
        zellij action write "$PANE_ID" "claude --resume $SESSION_ID\n"
        zellij action focus-pane --pane-id "$PANE_ID"
        ;;
    *)
        echo "Unknown pane strategy: $PANE_STRATEGY"
        echo "Options: new, current, pane:<id>"
        exit 1
        ;;
esac

# Notify daemon of resurrection
agent-console set "$(basename "$PWD")" working
```

### CLI Integration

```rust
/// Resurrect command with Zellij support
#[derive(Parser, Debug)]
struct ResurrectArgs {
    /// Session ID to resurrect
    session_id: String,

    /// Where to run the resurrected session
    #[arg(long, default_value = "auto")]
    pane: PaneStrategy,
}

#[derive(ValueEnum, Clone, Debug)]
enum PaneStrategy {
    /// Automatically choose: new pane in Zellij, current terminal otherwise
    Auto,
    /// Create new Zellij pane
    New,
    /// Use current/focused pane
    Current,
}

fn execute_resurrect(args: ResurrectArgs) -> Result<()> {
    let in_zellij = std::env::var("ZELLIJ").is_ok();

    let strategy = match args.pane {
        PaneStrategy::Auto => {
            if in_zellij {
                PaneStrategy::New
            } else {
                PaneStrategy::Current
            }
        }
        other => other,
    };

    match strategy {
        PaneStrategy::New if in_zellij => {
            zellij_new_pane_with_command(&format!(
                "claude --resume {}",
                args.session_id
            ))
        }
        _ => {
            // Run in current terminal
            std::process::Command::new("claude")
                .arg("--resume")
                .arg(&args.session_id)
                .spawn()?
                .wait()?;
            Ok(())
        }
    }
}
```

### Zellij Module

```rust
// src/integrations/zellij.rs

use std::process::Command;

/// Check if running inside Zellij
pub fn is_zellij_environment() -> bool {
    std::env::var("ZELLIJ").is_ok()
}

/// Create a new Zellij pane with the given command
pub fn new_pane_with_command(cmd: &str) -> Result<(), ZellijError> {
    let status = Command::new("zellij")
        .args(["action", "new-pane", "--"])
        .args(cmd.split_whitespace())
        .status()?;

    if status.success() {
        Ok(())
    } else {
        Err(ZellijError::PaneCreationFailed)
    }
}

/// Write a command to a specific pane
pub fn write_to_pane(pane_id: u32, text: &str) -> Result<(), ZellijError> {
    let status = Command::new("zellij")
        .args(["action", "write", &pane_id.to_string(), text])
        .status()?;

    if status.success() {
        Ok(())
    } else {
        Err(ZellijError::WriteToPane(pane_id))
    }
}

/// Focus a specific pane
pub fn focus_pane(pane_id: u32) -> Result<(), ZellijError> {
    let status = Command::new("zellij")
        .args(["action", "focus-pane", "--pane-id", &pane_id.to_string()])
        .status()?;

    if status.success() {
        Ok(())
    } else {
        Err(ZellijError::FocusPaneFailed(pane_id))
    }
}

#[derive(Debug, thiserror::Error)]
pub enum ZellijError {
    #[error("Failed to create new pane")]
    PaneCreationFailed,

    #[error("Failed to write to pane {0}")]
    WriteToPane(u32),

    #[error("Failed to focus pane {0}")]
    FocusPaneFailed(u32),

    #[error("IO error: {0}")]
    Io(#[from] std::io::Error),
}
```

### Workflow Diagram

```text
User selects closed session in dashboard
           │
           ▼
    ┌──────────────────┐
    │ Press 'r' to     │
    │ resurrect        │
    └────────┬─────────┘
             │
             ▼
    ┌──────────────────┐
    │ Detect Zellij    │──── Not in Zellij ────┐
    │ environment      │                        │
    └────────┬─────────┘                        │
             │ In Zellij                        ▼
             ▼                         ┌────────────────┐
    ┌──────────────────┐               │ Run claude     │
    │ Create new pane  │               │ --resume in    │
    │ via zellij CLI   │               │ current term   │
    └────────┬─────────┘               └────────┬───────┘
             │                                  │
             ▼                                  │
    ┌──────────────────┐                        │
    │ Run claude       │                        │
    │ --resume in pane │                        │
    └────────┬─────────┘                        │
             │                                  │
             └──────────────┬───────────────────┘
                            │
                            ▼
                   ┌────────────────────┐
                   │ Notify daemon:     │
                   │ Session = Working  │
                   └────────────────────┘
                            │
                            ▼
                   ┌────────────────────┐
                   │ Dashboard updates  │
                   │ to show Working    │
                   └────────────────────┘
```

### Configuration

```toml
# ~/.config/agent-console/config.toml

[integrations.zellij]
enabled = true

# Default pane strategy for resurrection
# Options: "new", "current", "auto"
resurrection_pane = "auto"

# Position for new resurrection panes
# Options: "right", "below", "floating"
new_pane_position = "right"
```

### Error Messages

| Error                | Message                                            | Recovery                     |
| -------------------- | -------------------------------------------------- | ---------------------------- |
| Zellij not installed | "Zellij not found. Running in current terminal."   | Fallback to current terminal |
| Pane creation failed | "Failed to create Zellij pane. Check Zellij logs." | Suggest manual pane creation |
| Session not found    | "Session 'abc123' not found in closed sessions."   | List available sessions      |
| Claude not installed | "Claude CLI not found. Install Claude Code first." | Link to installation docs    |

### Future Enhancements

- Tab-based resurrection (create new tab instead of pane)
- Named panes with session ID for easy identification
- Pane position preferences (left, right, above, below)
- Floating pane option for temporary resurrection
- Auto-close pane when session completes
- Resurrection history with keybinding (resurrect last closed)
