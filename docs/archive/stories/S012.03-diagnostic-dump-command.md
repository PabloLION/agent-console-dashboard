# Story: Add Diagnostic Dump Command

**Story ID:** S012.03 **Epic:**
[E012 - Logging and Diagnostics](../epic/E012-logging-and-diagnostics.md)
**Status:** Draft **Priority:** P3 **Estimated Points:** 2

## Description

As a developer debugging issues, I want to run `acd dump` to get a full JSON
snapshot of the daemon's internal state, So that I can inspect sessions, config,
and runtime details without connecting a debugger or parsing log files.

## Context

The health check command (S012.02) provides a high-level overview. The dump
command provides a detailed snapshot useful for bug reports and post-mortem
analysis. It serializes all daemon state (sessions, config, uptime, socket info)
as JSON to stdout. Per the epic, this command outputs JSON format (optionally
with `--format json` flag for explicitness).

## Implementation Details

### Technical Approach

1. Add `DUMP` IPC command to the socket server
2. Serialize full daemon state as JSON (sessions with all fields, uptime,
   connection count, socket path)
3. Add `dump` CLI subcommand that sends `DUMP` and prints the response
4. Support optional `--format json` flag (JSON is default and only format in v0)

### IPC Protocol

```text
DUMP
  Returns: OK <json>
  JSON payload: full daemon state including all sessions, config, uptime
```

### CLI Output (JSON)

```json
{
  "uptime_seconds": 9240,
  "socket_path": "/tmp/acd.sock",
  "sessions": [
    {
      "id": "abc123",
      "status": "Working",
      "working_dir": "/home/user/project",
      "created_at": "2026-01-31T10:00:00Z",
      "updated_at": "2026-01-31T12:34:00Z"
    }
  ],
  "session_counts": {
    "active": 3,
    "closed": 1
  },
  "connections": 2
}
```

### Files Modified

- `crates/agent-console-dashboard/src/main.rs` - Add `Dump` subcommand
- `crates/agent-console-dashboard/src/daemon/server.rs` - Add `DUMP` command
  handler
- `crates/agent-console-dashboard/src/lib.rs` - Add `DaemonDump` response type

### Dependencies

- [S012.02 - Health Check Command](./S012.02-health-check-command.md) - Shares
  IPC infrastructure and uptime tracking

## Acceptance Criteria

- [ ] `acd dump` outputs full daemon state as JSON
- [ ] Output includes: all sessions (with all fields), session counts, uptime,
      connection count, socket path
- [ ] Output is valid JSON (parseable by `serde_json`)
- [ ] `--format json` flag accepted (no-op, JSON is default)
- [ ] Exit code 0 when daemon is running, 1 when unreachable
- [ ] `DUMP` IPC command returns complete state
- [ ] `cargo test --workspace` passes
- [ ] `cargo clippy --workspace` passes

## Testing Requirements

- [ ] Unit test: `DUMP` command handler returns valid JSON
- [ ] Unit test: dump response includes all session fields
- [ ] Unit test: JSON output is parseable by `serde_json::from_str`
- [ ] Manual test: `acd dump` with daemon running
- [ ] Manual test: `acd dump --format json` produces same output
- [ ] Manual test: `acd dump` with daemon stopped (exit code 1)

## Out of Scope

- `--format text` human-readable output (defer to future enhancement)
- Filtering dump output by section or session ID
- Memory usage or OS-level process info beyond what's in health check
- Streaming dump updates or watch mode

## Notes

### DaemonDump Type

```rust
#[derive(Debug, serde::Serialize, serde::Deserialize)]
pub struct DaemonDump {
    pub uptime_seconds: u64,
    pub socket_path: String,
    pub sessions: Vec<SessionSnapshot>,
    pub session_counts: SessionCounts,
    pub connections: usize,
}

#[derive(Debug, serde::Serialize, serde::Deserialize)]
pub struct SessionSnapshot {
    pub id: String,
    pub status: String,
    pub working_dir: String,
    pub created_at: String,  // ISO 8601 format
    pub updated_at: String,  // ISO 8601 format
}

#[derive(Debug, serde::Serialize, serde::Deserialize)]
pub struct SessionCounts {
    pub active: usize,
    pub closed: usize,
}
```

> **Note:** `SessionCounts` is a shared type defined in the daemon's state
> module. Both health check and debug endpoints reference the same struct.

### CLI Signature

```bash
acd dump [--format json]   # JSON is default and only format in v0
```

The `--format` flag is accepted for forward compatibility but only supports
`json` in v0. Attempting `--format text` returns an error: "text format not yet
implemented".

### Timestamp Format

All timestamps are UTC. The `created_at` field uses ISO 8601 format with Z
suffix (e.g., `2026-01-31T10:00:00Z`).

### Usage Example

```bash
# Dump to file for bug report
acd dump > daemon-state.json

# Pipe to jq for inspection
acd dump | jq '.sessions[] | select(.status == "Attention")'
```
