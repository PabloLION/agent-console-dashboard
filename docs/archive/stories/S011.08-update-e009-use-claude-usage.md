# Story: Update E009 to Use claude-usage

**Story ID:** S011.08 **Epic:**
[E011 - Claude Usage Crate](../epic/E011-claude-usage-crate.md) **Status:** Draft
**Priority:** P2 **Estimated Points:** 2

## Description

As a maintainer, I want to update E009 documentation and implementation to use the `claude-usage` crate, So that credential handling and API logic are not duplicated across the project.

## Context

After E011 is complete, the `claude-usage` crate provides all credential fetching and API client functionality. E009 (API Usage Tracking) should consume this crate rather than implementing its own credential/API logic. This story updates the epic and stories to reflect the dependency and removes any duplicate documentation.

The clear separation: E011 fetches account-level usage data (`UsageData`), E009 tracks per-session token counts (`ApiUsage`). Both are needed but serve different purposes.

## Implementation Details

### Technical Approach

1. Review E009 epic and stories (S009.01-03) for overlap with E011
2. Add E011 as explicit dependency in E009 epic
3. Remove duplicated credential/API handling documentation from E009
4. Update code examples to use `claude_usage::get_usage()`
5. Clarify separation: E011 = fetch data, E009 = track and display
6. Update daemon implementation to call `claude_usage::get_usage()` periodically

### Files to Modify

- `docs/epic/E009-api-usage-tracking.md` - Add E011 dependency, update technical notes
- `docs/stories/S009.01-integrate-claude-usage-crate.md` - Reference claude-usage types if needed
- `docs/stories/S009.02-api-usage-command.md` - Update to use claude-usage for daemon data fetch
- `crates/agent-console-dashboard/Cargo.toml` - Add `claude-usage` dependency
- `crates/agent-console-dashboard/src/daemon/usage_fetcher.rs` - Use `claude_usage::get_usage()`

### Dependencies

- S011.06: `claude-usage` must be published to crates.io

## Acceptance Criteria

- [ ] Given E009 epic, when reviewed, then E011 is listed as dependency
- [ ] Given E009 stories, when reviewed, then no credential logic is duplicated
- [ ] Given code examples in E009, when reviewed, then they use `claude_usage` crate
- [ ] Given daemon usage fetcher, when implemented, then it calls `claude_usage::get_usage()`
- [ ] Given binary crate, when compiled, then `claude-usage` dependency is included

## Testing Requirements

- [ ] Documentation review: No duplicate logic between E009 and E011
- [ ] Code examples compile with `claude-usage` dependency
- [ ] Daemon can fetch usage via `claude-usage` crate

## Out of Scope

- Changing E009 structure or stories (just dependency and implementation)
- Merging E009 and E011 epics (they serve different purposes)

## Notes

### E009 Epic Updates

Add to Dependencies section:

```markdown
## Dependencies

- [E011 - Claude Usage Crate](./E011-claude-usage-crate.md) - Provides
  credential fetching and usage API client for account-level quota data
```

Update Technical Notes section:

```markdown
### Data Source

Account-level usage data is fetched using the `claude-usage` crate:

```rust
use claude_usage::get_usage;

// In daemon, fetch every 3 minutes
let usage = get_usage()?;
// usage.five_hour.utilization, usage.seven_day.utilization
```

The daemon periodically fetches this data (every 3 minutes per D4 decision) and
broadcasts to connected clients. See [widget data flow](../architecture/widget-data-flow.md)
for full architecture.
```

### S009.02 Updates

Replace credential fetching code examples with:

```rust
// In daemon usage fetcher module

use claude_usage::get_usage;

pub struct UsageFetcher {
    // ... fields ...
}

impl UsageFetcher {
    pub async fn fetch_and_broadcast(&self) -> Result<(), Error> {
        // Fetch account-level usage from Anthropic
        let usage_data = get_usage()
            .map_err(|e| Error::UsageFetch(e.to_string()))?;

        // Broadcast to all connected TUIs
        self.broadcaster.send_usage_update(usage_data)?;

        Ok(())
    }
}
```

### Clear Separation of Concerns

| Epic | Responsibility | Data Type |
|------|---------------|-----------|
| E011 | Fetch account-level quota from Anthropic | `UsageData` (5h/7d utilization %) |
| E009 | Track per-session token consumption | `ApiUsage` (input/output tokens per request) |

Both are needed:

- **E011 data** answers: "Am I approaching my rate limit?"
- **E009 data** answers: "How many tokens did this session use?"

The daemon combines both: fetches E011 data periodically, tracks E009 data from hooks.

### Dependencies in Cargo.toml

```toml
[dependencies]
# ... existing dependencies ...
claude-usage = "0.1"
```

### Integration Point

The daemon's usage fetcher (S009.02 implementation) is the primary integration point. It calls `claude_usage::get_usage()` every 3 minutes (per D4) and broadcasts the result to all connected TUI dashboards.
