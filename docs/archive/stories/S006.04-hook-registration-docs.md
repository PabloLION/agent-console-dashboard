# Story: Document Hook Registration in settings.json

**Story ID:** S006.04 **Epic:**
[E006 - Claude Code Integration](../epic/E006-claude-code-integration.md)
**Status:** Draft **Priority:** P2 **Estimated Points:** 1

## Description

As a user, I want clear documentation on how to register hooks in Claude Code
settings, So that I can easily set up the dashboard integration with my Claude
Code installation.

## Context

The hook scripts (S006.01-S006.03) need to be registered in Claude Code's
settings file before they will be invoked. This story creates comprehensive
documentation that guides users through the registration process, including file
locations, JSON format, troubleshooting, and verification steps.

Good documentation is essential for adoption - users shouldn't have to guess how
to configure hooks or debug registration issues. The documentation must reflect
that Claude Code passes JSON via stdin to ALL hooks, and that `session_id` is
the primary identifier (not `basename $PWD`). See
[discussion decision D8](../architecture/2026-01-31-discussion-decisions.md).

## Implementation Details

### Technical Approach

1. Create `docs/integration/claude-code-hooks.md` comprehensive guide
2. Document the settings.json location and format
3. Provide step-by-step installation instructions
4. Include troubleshooting section for common issues
5. Add verification commands to confirm hooks are working
6. Update README.md with quick-start hook setup
7. Clarify JSON stdin format and session_id usage

### Files to Modify

- `docs/integration/claude-code-hooks.md` - Create comprehensive hook
  documentation
- `README.md` - Add quick-start section for hook setup
- `scripts/hooks/README.md` - Document individual hook scripts

### Dependencies

- [S006.01 - Stop Hook Script](./S006.01-stop-hook-script.md) - Hook scripts
  must exist
- [S006.02 - User Prompt Submit Hook](./S006.02-user-prompt-submit-hook.md) -
  Hook scripts must exist
- [S006.03 - Notification Hook Script](./S006.03-notification-hook-script.md) -
  Hook scripts must exist

## Acceptance Criteria

- [ ] Given a new user reads the documentation, when they follow the steps, then
      hooks are correctly registered
- [ ] Given the settings.json format, when documented, then all required fields
      and arrays are explained
- [ ] Given a user has registration issues, when they check troubleshooting
      section, then common problems are addressed
- [ ] Given hooks are registered, when user runs verification commands, then
      they can confirm hooks work
- [ ] Given the documentation exists, when linked from README.md, then users can
      easily find it
- [ ] Given Claude Code's settings.json location varies by OS, when documented,
      then all platforms are covered
- [ ] Given version requirements, when documented, then minimum Claude Code
      version is stated (v2.0.76+ for PreToolUse hook support)
- [ ] Given JSON stdin is the data source, when documented, then session_id
      extraction is explained clearly

## Testing Requirements

- [ ] Manual test: Follow documentation steps on a clean Claude Code
      installation
- [ ] Manual test: Verify all code examples are syntactically correct
- [ ] Manual test: Test verification commands work as documented
- [ ] Review: Have someone unfamiliar with the project follow the guide

## Out of Scope

- Automatic registration (users edit settings.json manually)
- GUI configuration tool
- Hook management commands in agent-console CLI
- Windows-specific documentation

## Notes

### Documentation Structure

```markdown
# Claude Code Hooks Integration

## Overview

Brief explanation of what hooks do and why they're useful.

## Prerequisites

- Agent Console Dashboard installed
- Claude Code v2.0.76+ (for PreToolUse hook support)
- Bash shell available
- jq command-line JSON processor

## Quick Start

Minimal steps to get hooks working.

## Detailed Setup

### Step 1: Copy Hook Scripts

Where to copy scripts and how to make them executable.

### Step 2: Configure settings.json

Full settings.json example and explanation.

### Step 3: Verify Installation

How to test that hooks are working.

## Settings.json Reference

Complete documentation of hook configuration options.

## Hook JSON Format

Explanation of JSON stdin data passed to hooks.

## Troubleshooting

Common issues and solutions.

## Advanced Configuration

Custom hooks, multiple instances, etc.
```

### Settings.json Location

| Platform | Path                                  |
| -------- | ------------------------------------- |
| macOS    | `~/.claude/settings.json`             |
| Linux    | `~/.claude/settings.json`             |
| Windows  | `%USERPROFILE%\.claude\settings.json` |

### Example settings.json

```json
{
  "hooks": {
    "Stop": ["~/.claude/hooks/stop.sh"],
    "UserPromptSubmit": ["~/.claude/hooks/user-prompt-submit.sh"],
    "Notification": ["~/.claude/hooks/notification.sh"]
  }
}
```

### Hook Registration Format

The `hooks` object maps hook names to arrays of script paths:

```json
{
  "hooks": {
    "<HookName>": ["<path/to/script1>", "<path/to/script2>"]
  }
}
```

- Hook names are case-sensitive: `Stop`, `UserPromptSubmit`, `Notification`
- Each hook can have multiple scripts (executed in order)
- Scripts can be absolute paths or `~` for home directory
- Scripts must be executable (`chmod +x`)

### Hook JSON Stdin Format

Claude Code passes JSON data via stdin to ALL hooks. Every hook receives:

| Field             | Type   | Description                     |
| ----------------- | ------ | ------------------------------- |
| `session_id`      | string | Unique session identifier       |
| `cwd`             | string | Current working directory       |
| `transcript_path` | string | Path to conversation transcript |
| `permission_mode` | string | Current permission mode         |
| `hook_event_name` | string | Which hook fired (Stop, etc.)   |

Plus event-specific fields (e.g., `prompt` for UserPromptSubmit, `message` for
Notification).

See [D8](../architecture/2026-01-31-discussion-decisions.md) for full details.

**Critical:** Scripts must parse JSON stdin to extract `session_id`. The
`basename "$PWD"` pattern is stale and incorrect.

### Troubleshooting Section Topics

1. **Hooks not firing**
   - Check settings.json syntax (valid JSON)
   - Verify hook name spelling (case-sensitive)
   - Ensure scripts are executable
   - Check Claude Code version (v2.0.76+ for PreToolUse)

2. **Dashboard not updating**
   - Verify daemon is running: `agent-console list`
   - Check agent-console is in PATH
   - Test script manually with sample JSON:
     `echo '{"session_id":"test"}' | ./stop.sh`
   - Check jq is installed: `which jq`

3. **Permission denied**
   - Run `chmod +x ~/.claude/hooks/*.sh`
   - Check file ownership

4. **Wrong session ID extracted**
   - Hooks must parse JSON stdin, not use `basename $PWD`
   - Verify jq is installed and working
   - Test JSON parsing: `echo '{"session_id":"abc123"}' | jq -r '.session_id'`

5. **Multiple hooks issue**
   - Each hook type is an array
   - Check for duplicate entries

### Verification Commands

```bash
# Test that agent-console is working
agent-console list

# Test hook script manually with sample JSON
echo '{"session_id":"test-session","cwd":"/tmp","hook_event_name":"Stop"}' | ~/.claude/hooks/stop.sh

# Check dashboard shows the update
agent-console tui

# Clean up test
agent-console rm test-session
```

### Integration with Existing settings.json

If the user already has a settings.json with other configurations:

```json
{
  "existingSetting": "value",
  "hooks": {
    "Stop": ["~/.claude/hooks/stop.sh"]
  }
}
```

The documentation should explain how to merge hook configuration with existing
settings without overwriting other configurations.

### Minimum Version Requirement

Claude Code v2.0.76+ is required for PreToolUse hook support (AskUserQuestion
detection). Earlier versions support Stop, UserPromptSubmit, and Notification
hooks.

### Dependencies

Users must have `jq` installed for JSON parsing in hook scripts:

**macOS:**

```bash
brew install jq
```

**Linux:**

```bash
sudo apt-get install jq  # Debian/Ubuntu
sudo yum install jq      # RHEL/CentOS
```
